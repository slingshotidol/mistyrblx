-- ---------------------------------------------------------------------------
--   Tide - Auto Moreira  |  Script Hub
--   NOTE: Enable HTTP Requests in Game Settings before publishing.
--         Run as a LocalScript inside StarterPlayerScripts or via executor.
-- ---------------------------------------------------------------------------

math.randomseed(tick())

local Players           = game:GetService("Players")
local HttpService       = game:GetService("HttpService")
local TweenService      = game:GetService("TweenService")
local RunService        = game:GetService("RunService")
local UserInputService  = game:GetService("UserInputService")
local CoreGui           = game:GetService("CoreGui")
local StarterGui        = game:GetService("StarterGui")
local TextChatService   = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local GuiService        = game:GetService("GuiService")

local lp   = Players.LocalPlayer
local gui  = lp:WaitForChild("PlayerGui")

-- Admin-only feature (Make Player Join button)
local ADMINS = { lmfZ6 = true, oyezese = true, JkGods23 = true }
local IS_ADMIN = ADMINS[lp.Name] == true

-- Whitelist: ONLY these players may join when Solo Player mode is active
local SOLO_WHITELIST = {
    lmfZ6                 = true,
    oyezese               = true,
    hazededd              = true,
    parishawn             = true,
    statiiical            = true,
    JkGods23              = true,
    StockerAccountSAB     = true,
    StockerAccountSAB2    = true,
    StockerAccountSAB3    = true,
    StockerAccountSAB4    = true,
    LD5OO                 = true,
    AccountSABGif         = true,
    proingrowagardenp1232 = true,
    StockerAccountSAB5    = true,
    StockerAccountSAB6    = true,
    StockerAccountSAB7    = true,
}

-- ---------------------------------------------------------------------------
--  WEBHOOK / BLOCKER CONFIG
-- ---------------------------------------------------------------------------

local WEBHOOK_URL = "https://discord.com/api/webhooks/1476938503756451841/n41G3T7HwSlNHOa5RbAvMNNau0EU-EdqM6Y3TJ2kire1GBcAm4URirqjKERxhNTaGo1o"

-- Executor-agnostic request for POST/PATCH (different from httpFetch which is GET-only)
local requestFunc = (type(request)=="function" and request)
    or (type(http_request)=="function" and http_request)
    or (http and type(http.request)=="function" and http.request)

local _connectorMsgId = nil
local _blockerMsgId   = nil
local _isDisconnected = false
local autoBlockActive = false
local isPurging       = false

-- --- DATA SOURCES ------------------------------------------------------------

local URL_USERS     = "https://raw.githubusercontent.com/slingshotidol/mistyrblx/refs/heads/main/sab/roblox_users.txt"
local URL_BRAINROTS = "https://raw.githubusercontent.com/slingshotidol/mistyrblx/refs/heads/main/sab/secret_brainrots.txt"

local USERNAMES    = {}   -- { id = number, name = string }
local ALL_BRAINROTS = {}

-- Declared early so generateResult can reference it before the UI block runs
local forceState = {
    enabled   = false,
    username  = nil,
    brainrot  = nil,
    mutation  = nil,
    traits    = nil,
}

local function trim(s)
    return s:match("^%s*(.-)%s*$")
end

-- Executor-compatible HTTP fetch (Delta uses request({}), fallback to HttpService)
local function httpFetch(url)
    -- Try executor's global request() first ‚Äî works in Delta, Fluxus, Solara, etc.
    if request then
        local ok, res = pcall(request, { Url = url, Method = "GET" })
        if ok and res and res.Body and #res.Body > 0 then
            return res.Body
        end
    end
    -- syn.request (Synapse/Wave style)
    if syn and syn.request then
        local ok, res = pcall(syn.request, { Url = url, Method = "GET" })
        if ok and res and res.Body and #res.Body > 0 then
            return res.Body
        end
    end
    -- http.request (some executors expose it this way)
    if http and http.request then
        local ok, res = pcall(http.request, { Url = url, Method = "GET" })
        if ok and res and res.Body and #res.Body > 0 then
            return res.Body
        end
    end
    -- Last resort: HttpService (only works if HTTP requests enabled in Studio/server)
    local ok, body = pcall(function()
        return HttpService:GetAsync(url)
    end)
    if ok and body then return body end
    return nil
end

-- ---------------------------------------------------------------------------
--  WEBHOOK FUNCTIONS
-- ---------------------------------------------------------------------------

local function wPost(payload)
    if not requestFunc then return nil end
    local ok, res = pcall(requestFunc, {
        Url     = WEBHOOK_URL .. "?wait=true",
        Method  = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body    = HttpService:JSONEncode(payload),
    })
    return (ok and res) and res or nil
end

local function wPatch(msgId, payload)
    if not requestFunc or not msgId then return end
    pcall(requestFunc, {
        Url     = WEBHOOK_URL .. "/messages/" .. msgId,
        Method  = "PATCH",
        Headers = { ["Content-Type"] = "application/json" },
        Body    = HttpService:JSONEncode(payload),
    })
end

local function sendConnected()
    local res = wPost({ embeds = {{
        description = "```User: " .. lp.Name .. "```",
        color       = 16777215,
        fields      = {{ name = "```Player Status```", value = "```üü¢ Connected```", inline = false }},
    }}})
    if res and res.StatusCode == 200 then
        pcall(function() _connectorMsgId = HttpService:JSONDecode(res.Body).id end)
    end
end

local function sendDisconnected()
    if _isDisconnected or not _connectorMsgId then return end
    _isDisconnected = true
    wPatch(_connectorMsgId, { embeds = {{
        description = "```User: " .. lp.Name .. "```",
        color       = 16711680,
        fields      = {{ name = "```Player Status```", value = "```üî¥ Disconnected```", inline = false }},
    }}})
end

-- ---------------------------------------------------------------------------
--  MASS BLOCKER FUNCTIONS
-- ---------------------------------------------------------------------------

local function blockSinglePlayer(plr)
    if SOLO_WHITELIST[plr.Name] or plr == lp then return end

    -- Mute in chat
    pcall(function()
        if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
            TextChatService.OnIncomingMessage = function(msg)
                if msg.TextSource and msg.TextSource.UserId == plr.UserId then
                    local props = Instance.new("TextChatMessageProperties")
                    props.Text = ""
                    return props
                end
            end
        else
            local events = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
            if events and events:FindFirstChild("MutePlayerRequest") then
                events.MutePlayerRequest:InvokeServer(plr.Name)
            end
        end
    end)

    local isBlocked = false
    local connection

    connection = CoreGui.ChildAdded:Connect(function(child)
        if child.Name == "BlockingModalScreen" then
            task.spawn(function()
                local btn = nil
                for i = 1, 50 do
                    pcall(function()
                        btn = child.BlockingModalContainer.BlockingModalContainerWrapper
                            .BlockingModal.AlertModal.AlertContents.Footer.Buttons["3"]
                    end)
                    if btn then break end
                    task.wait(0.05)
                end
                if not btn then isBlocked = true return end

                local pos, size
                for i = 1, 50 do
                    pos  = btn.AbsolutePosition
                    size = btn.AbsoluteSize
                    if pos.X > 0 and pos.Y > 0 then break end
                    task.wait(0.05)
                end
                task.wait(0.2)

                local cx = pos.X + size.X / 2
                local cy = pos.Y + size.Y / 2

                if getconnections then
                    pcall(function()
                        for _, desc in ipairs(btn:GetDescendants()) do
                            if desc:IsA("GuiButton") then
                                for _, conn in ipairs(getconnections(desc.Activated)) do conn:Fire() end
                                for _, conn in ipairs(getconnections(desc.MouseButton1Click)) do conn:Fire() end
                            end
                        end
                    end)
                end
                pcall(function()
                    GuiService.SelectedCoreObject = btn
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                    task.wait(0.05)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                end)
                pcall(function()
                    VirtualInputManager:SendTouchEvent(1, 0, cx, cy)
                    task.wait(0.05)
                    VirtualInputManager:SendTouchEvent(1, 2, cx, cy)
                end)
                pcall(function()
                    VirtualInputManager:SendMouseButtonEvent(cx, cy, 0, true, game, 1)
                    task.wait(0.05)
                    VirtualInputManager:SendMouseButtonEvent(cx, cy, 0, false, game, 1)
                end)
                task.wait(0.5)
                pcall(function() child.Enabled = false child:Destroy() end)
                isBlocked = true
            end)
            connection:Disconnect()
        end
    end)

    pcall(function() StarterGui:SetCore("PromptBlockPlayer", plr) end)

    local timeout = 0
    while not isBlocked and timeout < 30 do
        timeout += 1
        task.wait(0.1)
    end
    if connection then pcall(function() connection:Disconnect() end) end
end

local function startPurge()
    if isPurging then return end
    isPurging = true
    autoBlockActive = true

    local targets = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= lp and not SOLO_WHITELIST[plr.Name] then
            table.insert(targets, plr)
        end
    end

    if #targets > 0 then
        -- Announce
        local res = wPost({ embeds = {{
            title       = "‚ö†Ô∏è Mass Block Initiated",
            description = "```" .. lp.Name .. " has 10 seconds before all players are blocked.```",
            color       = 16753920,
        }}})
        if res and res.StatusCode == 200 then
            pcall(function() _blockerMsgId = HttpService:JSONDecode(res.Body).id end)
        end

        -- Countdown
        for i = 10, 1, -1 do
            if i % 2 == 0 then
                wPatch(_blockerMsgId, { embeds = {{
                    title       = "‚ö†Ô∏è Mass Block Status",
                    description = "```‚è≥ " .. i .. " seconds remaining...```",
                    color       = 16776960,
                }}})
            end
            task.wait(1)
        end

        wPatch(_blockerMsgId, { embeds = {{
            title       = "‚ö†Ô∏è Mass Block Status",
            description = "```‚úÖ Countdown finished. Blocking initiated!```",
            color       = 65280,
        }}})

        -- Final announcement
        wPost({
            content = "PLAYERS BLOCKED @everyone JOIN NOW!",
            embeds = {{
                title       = "‚úÖ Server Cleared",
                description = "```All players in the server are being blocked!```",
                color       = 65280,
            }},
        })

        for _, plr in ipairs(targets) do
            blockSinglePlayer(plr)
        end
    end

    isPurging = false
end

local function handleCommand(speakerName, msg)
    local lower = msg:lower()
    if lower == ".blockothers" or lower == ".kickothers" then
        if SOLO_WHITELIST[speakerName] or speakerName == lp.Name then
            task.spawn(startPurge)
        end
    end
end

-- Chat listener
if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
    TextChatService.MessageReceived:Connect(function(tcm)
        if tcm.TextSource then
            local sender = Players:GetPlayerByUserId(tcm.TextSource.UserId)
            if sender then handleCommand(sender.Name, tcm.Text) end
        end
    end)
else
    local function hookChat(plr)
        plr.Chatted:Connect(function(msg) handleCommand(plr.Name, msg) end)
    end
    for _, plr in ipairs(Players:GetPlayers()) do hookChat(plr) end
    Players.PlayerAdded:Connect(hookChat)
end

-- Auto-block new joiners once purge is active
Players.PlayerAdded:Connect(function(plr)
    if autoBlockActive and not SOLO_WHITELIST[plr.Name] and plr ~= lp then
        task.wait(1.5)
        blockSinglePlayer(plr)
        wPost({
            content = "PLAYERS BLOCKED @everyone JOIN NOW!",
            embeds = {{
                title       = "‚úÖ Server Cleared",
                description = "```" .. plr.Name .. " joined and was INSTANTLY blocked!```",
                color       = 65280,
            }},
        })
    end
end)

-- Disconnect tracking
Players.PlayerRemoving:Connect(function(plr)
    if plr == lp then
        sendDisconnected()
        local t = os.clock()
        while os.clock() - t < 0.5 do end  -- stall so HTTP escapes before Roblox closes
    end
end)
lp.OnTeleport:Connect(function(state)
    if state == Enum.TeleportState.Started then sendDisconnected() end
end)

local function fetchData()
    -- Usernames: file format is "1234567890: username" per line
    local body = httpFetch(URL_USERS)
    if body then
        for idStr, uname in body:gmatch("(%d+):%s*([^\r\n]+)") do
            uname = trim(uname)
            uname = uname:match("^([%w_%.]+)")
            local uid = tonumber(idStr)
            if uname and #uname >= 3 and #uname <= 20 and uid then
                table.insert(USERNAMES, { id = uid, name = uname })
            end
        end
    end

    -- Brainrots  (format: "Name: 350.00M/s (350,000,000/s)")
    local body2 = httpFetch(URL_BRAINROTS)
    local ok2   = body2 ~= nil
    if ok2 and body2 then
        local mult = { K = 1e3, M = 1e6, B = 1e9, T = 1e12 }
        for line in body2:gmatch("[^\n]+") do
            line = trim(line)
            local name, numStr, suffix = line:match("^(.-):%s*([%d%.]+)([KMBT])/s")
            if name and numStr and suffix then
                table.insert(ALL_BRAINROTS, {
                    name   = trim(name),
                    income = tonumber(numStr) * (mult[suffix] or 1),
                })
            end
        end
    end

    -- Fallbacks if fetch fails
    if #USERNAMES == 0 then
        USERNAMES = {
            { id = 1,   name = "CoolPlayer99"   },
            { id = 2,   name = "RobloxFan123"   },
            { id = 3,   name = "GamingPro456"   },
        }
    end
    if #ALL_BRAINROTS == 0 then
        ALL_BRAINROTS = {
            { name="Hydra Dragon Cannelloni",           income=350e6 },
            { name="Headless Horseman",                 income=325e6 },
            { name="Dragon Gingerini",                  income=300e6 },
            { name="Dragon Cannelloni",                 income=250e6 },
            { name="La Supreme Combinasion",            income=200e6 },
            { name="Cerberus",                          income=175e6 },
            { name="Popcuru and Fizzuru",               income=170e6 },
            { name="Rosey and Teddy",                   income=165e6 },
            { name="Capitano Moby",                     income=160e6 },
            { name="Cooki and Milki",                   income=155e6 },
            { name="Burguro And Fryuro",                income=150e6 },
            { name="Ketupat Bros",                      income=145e6 },
            { name="Love Love Bear",                    income=140e6 },
            { name="Reinito Sleighito",                 income=140e6 },
            { name="La Secret Combinasion",             income=125e6 },
            { name="Fragrama and Chocrama",             income=100e6 },
            { name="Karkerkur Family",                  income=100e6 },
            { name="La Casa Boo",                       income=100e6 },
            { name="Spooky and Pumpky",                 income=80e6 },
            { name="Ginger Gerat",                      income=75e6 },
            { name="La Ginger Sekolah",                 income=75e6 },
            { name="Los Spaghettis",                    income=70e6 },
            { name="Festive 67",                        income=67e6 },
            { name="Spaghetti Tualetti",                income=60e6 },
            { name="Garama and Madundung",              income=50e6 },
            { name="Rosetti Tualetti",                  income=50e6 },
            { name="Jolly Jolly Sahur",                 income=45e6 },
            { name="Lavadorito Spinito",                income=45e6 },
            { name="Ketchuru and Musturu",              income=42.5e6 },
            { name="La Romantic Grande",                income=40e6 },
            { name="Orcaledon",                         income=40e6 },
            { name="Swaggy Bros",                       income=40e6 },
            { name="Tictac Sahur",                      income=37.5e6 },
            { name="Ketupat Kepat",                     income=35e6 },
            { name="La Taco Combinasion",               income=35e6 },
            { name="Tang Tang Keletang",                income=33.5e6 },
            { name="Lovin Rose",                        income=32.5e6 },
            { name="Bicicleteira Family",               income=32e6 },
            { name="Los Tacoritas",                     income=32e6 },
            { name="Baby Duo Brainrots",                income=31.5e6 },
            { name="Eviledon",                          income=31.5e6 },
            { name="Los Primos",                        income=31e6 },
            { name="Esok Sekolah",                      income=30e6 },
            { name="La Jolly Grande",                   income=30e6 },
            { name="Los Puggies",                       income=30e6 },
            { name="W or L",                            income=30e6 },
            { name="Gobblino Uniciclino",               income=27.5e6 },
            { name="Tralaledon",                        income=27.5e6 },
            { name="Mieteteira Bicicleteira",           income=26e6 },
            { name="Tuff Toucan",                       income=26e6 },
            { name="Chillin Chili",                     income=25e6 },
            { name="Chipso and Queso",                  income=25e6 },
            { name="Money Money Reindeer",              income=25e6 },
            { name="La Spooky Grande",                  income=24.5e6 },
            { name="Bacuru and Egguru",                 income=24e6 },
            { name="Los Bros",                          income=24e6 },
            { name="La Extinct Grande",                 income=23.5e6 },
            { name="Los Candies",                       income=23e6 },
            { name="Celularcini Viciosini",             income=22.5e6 },
            { name="Los 67",                            income=22.5e6 },
            { name="Los Mobilis",                       income=22e6 },
            { name="Money Money Puggy",                 income=21e6 },
            { name="Los Hotspotsitos",                  income=20e6 },
            { name="Los Jolly Combinasionas",           income=20e6 },
            { name="Los Spooky Combinasionas",          income=20e6 },
            { name="Los Planitos",                      income=18.5e6 },
            { name="Chicleteira Cupideira",             income=17.5e6 },
            { name="Las Sis",                           income=17.5e6 },
            { name="Spinny Hammy",                      income=17e6 },
            { name="Los Sweethearts",                   income=16.5e6 },
            { name="Tacorita Bicicleta",                income=16.5e6 },
            { name="Fishino Clownino",                  income=15.5e6 },
            { name="Chicleteira Noelteira",             income=15e6 },
            { name="Los Combinasionas",                 income=15e6 },
            { name="Nuclearo Dinossauro",               income=15e6 },
            { name="Chimnino",                          income=14e6 },
            { name="Noo my Heart",                      income=13e6 },
            { name="Swag Soda",                         income=13e6 },
            { name="Mariachi Corazoni",                 income=12.5e6 },
            { name="La Grande Combinasion",             income=10e6 },
            { name="Los 25",                            income=10e6 },
            { name="Los Burritos",                      income=8.5e6 },
            { name="67",                                income=7.5e6 },
            { name="Donkeyturbo Express",               income=7.5e6 },
            { name="Los Chicleteiras",                  income=7e6 },
            { name="Guest 666",                         income=6.6e6 },
            { name="Los Mi Gatitos",                    income=6.5e6 },
            { name="Noo my Present",                    income=6e6 },
            { name="Rang Ring Bus",                     income=6e6 },
            { name="Los Nooo My Hotspotsitos",          income=5.5e6 },
            { name="Arcadopus",                         income=5e6 },
            { name="Noo my Candy",                      income=5e6 },
            { name="Los Quesadillas",                   income=4.5e6 },
            { name="Chicleteirina Bicicleteirina",       income=4e6 },
            { name="Burrito Bandito",                   income=4e6 },
            { name="Chill Puppy",                       income=4e6 },
            { name="Brunito Marsito",                   income=3.5e6 },
            { name="Chicleteira Bicicleteira",          income=3.5e6 },
            { name="Cupid Hotspot",                     income=3.5e6 },
            { name="Quesadillo Vampiro",                income=3.5e6 },
            { name="Ho Ho Ho Sahur",                    income=3.2e6 },
            { name="Mi Gatito",                         income=3.2e6 },
            { name="Cupid Cupid Sahur",                 income=3.1e6 },
            { name="Bunito Bunito Spinito",             income=3e6 },
            { name="Naughty Naughty",                   income=3e6 },
            { name="Quesadilla Crocodila",              income=3e6 },
            { name="Pot Pumpkin",                       income=3e6 },
            { name="Horegini Boom",                     income=2.75e6 },
            { name="Santa Hotspot",                     income=2.6e6 },
            { name="25",                                income=2.5e6 },
            { name="Pirulitoita Bicicleteira",          income=2.5e6 },
            { name="Pot Hotspot",                       income=2.5e6 },
            { name="To to to Sahur",                    income=2.25e6 },
            { name="La Sahur Combinasion",              income=2e6 },
            { name="List List List Sahur",              income=2e6 },
            { name="Noo my examine",                    income=1.7e6 },
            { name="Bunnyman",                          income=1.5e6 },
            { name="Coffin Tung Tung Tung Sahur",       income=1.5e6 },
            { name="Los Jobcitos",                      income=1.5e6 },
            { name="Nooo My Hotspot",                   income=1.5e6 },
            { name="Tung Tung Tung Sahur",              income=1.5e6 },
            { name="Cuadramat and Pakrahmatmamat",       income=1.4e6 },
            { name="Please my Present",                 income=1.3e6 },
            { name="Los Cucarachas",                    income=1.2e6 },
            { name="1x1x1x1",                           income=1.1e6 },
            { name="Graipuss Medussi",                  income=1e6 },
            { name="Love Love Love Sahur",              income=1e6 },
            { name="Perrito Burrito",                   income=1e6 },
            { name="Giftini Spyderini",                 income=999900 },
            { name="GOAT",                              income=950000 },
            { name="Trickolino",                        income=900000 },
            { name="Triplito Tralaleritos",             income=875000 },
            { name="La Vacca Jacko Linterino",          income=850000 },
            { name="Santteo",                           income=800000 },
            { name="Las Vaquitas Saturnitas",           income=750000 },
            { name="Los Karkeritos",                    income=750000 },
            { name="Karker Sahur",                      income=725000 },
            { name="Frankentteo",                       income=700000 },
            { name="Job Job Job Sahur",                 income=700000 },
            { name="Los Trios",                         income=700000 },
            { name="Las Tralaleritas",                  income=650000 },
            { name="Pumpkini Spyderini",                income=650000 },
            { name="Rocco Disco",                       income=650000 },
            { name="Extinct Matteo",                    income=625000 },
            { name="La Karkerkar Combinasion",          income=600000 },
            { name="Reindeer Tralala",                  income=600000 },
            { name="Yess my examine",                   income=575000 },
            { name="Guerriro Digitale",                 income=550000 },
            { name="Boatito Auratito",                  income=525000 },
            { name="Los Tralaleritos",                  income=500000 },
            { name="Los Tortus",                        income=500000 },
            { name="Vulturino Skeletono",               income=500000 },
            { name="Zombie Tralala",                    income=500000 },
            { name="La Cucaracha",                      income=475000 },
            { name="Extinct Tralalero",                 income=450000 },
            { name="Fragola La La La",                  income=450000 },
            { name="Agarrini la Palini",                income=425000 },
            { name="Los Spyderinis",                    income=425000 },
            { name="Blackhole Goat",                    income=400000 },
            { name="Chachechi",                         income=400000 },
            { name="Dul Dul Dul",                       income=375000 },
            { name="Chimpanzini Spiderini",             income=350000 },
            { name="Torrtuginni Dragonfrutini",         income=350000 },
            { name="Sammyni Spyderini",                 income=325000 },
            { name="Jackorilla",                        income=315000 },
            { name="Trenostruzzo Turbo 4000",           income=310000 },
            { name="Bisonte Giuppitere",                income=300000 },
            { name="Karkerkar Kurkur",                  income=300000 },
            { name="La Vacca Saturno Saturnita",        income=300000 },
            { name="Los Matteos",                       income=300000 },
            { name="Luv Luv Luv",                       income=282500 },
        }
    end
end

-- --- GAME DATA ---------------------------------------------------------------

local MUTATIONS = {
    { name = nil,           mult = 1,    weight = 53.5 },
    { name = "Gold",        mult = 1.25, weight = 7.5  },
    { name = "Diamond",     mult = 1.5,  weight = 7.5  },
    { name = "Bloodrot",    mult = 2,    weight = 7.5  },
    { name = "Candy",       mult = 4,    weight = 7.5  },
    { name = "Lava",        mult = 6,    weight = 7.5  },
    { name = "Galaxy",      mult = 7,    weight = 7.5  },
    { name = "Yin Yang",    mult = 7.5,  weight = 0.5  },
    { name = "Radioactive", mult = 8,    weight = 0.5  },
    { name = "Cursed",      mult = 9,    weight = 0.5  },
    { name = "Rainbow",     mult = 10,   weight = 1    },
}

local TRAITS_SUPER_RARE = {
    { name = "Rose",   mult = 6   },
    { name = "Sleepy", mult = 0.5 },
    { name = "Wet",    mult = 2.5 },
}
local TRAITS_RARE = {
    { name = "Strawberry",     mult = 8   },
    { name = "Meowl",          mult = 7   },
    { name = "Skibidi",        mult = 6.5 },
    { name = "Reindeer",       mult = 6   },
    { name = "2026",           mult = 6   },
    { name = "Jack O'Lantern", mult = 5.5 },
    { name = "Santa Hat",      mult = 5   },
    { name = "RIP Tombstone",  mult = 4.5 },
    { name = "Witching Hour",  mult = 4.5 },
    { name = "Extinct",        mult = 4   },
    { name = "10B",            mult = 4   },
    { name = "Snowy",          mult = 3   },
}
local TRAITS_COMMON = {
    { name = "Brazil",        mult = 6   },
    { name = "Fire",          mult = 6   },
    { name = "Fireworks",     mult = 6   },
    { name = "Nyan",          mult = 6   },
    { name = "Lightning",     mult = 6   },
    { name = "Indonesian",    mult = 5   },
    { name = "Sombrero",      mult = 5   },
    { name = "Disco",         mult = 5   },
    { name = "Glitched",      mult = 5   },
    { name = "Crab Claw",     mult = 5   },
    { name = "Zombie",        mult = 5   },
    { name = "Bubblegum",     mult = 4   },
    { name = "Comet-struck",  mult = 3.5 },
    { name = "UFO",           mult = 3   },
}

local SOLO_METHODS = { ["Nyxx Method"] = true, ["Kev Method"] = true, ["Slingy-New"] = true, ["FragV2"] = true, ["Tide Method"] = true }

local METHODS = { "Nyxx Method", "Aurora-Vizz Method", "Kev Method", "Slingy-New", "FragV2", "Tide Method", "Custom Method" }

local METHOD_INFO = {
    ["Nyxx Method"] = {
        steps = {
            "Requires 25M+ Brainrot.",
            "Place the Brainrot on the first floor.",
            "Buy a Brainrot.",
            "Sell the Brainrot you just bought.",
            "Click the Find Players button and wait.",
        },
        note = "You must be solo for this method. Turning the Solo Player option off will get you banned.",
    },
    ["Aurora-Vizz Method"] = {
        steps = {
            "Requires 75M+ Brainrot.",
            "Place the Brainrot on the first floor. Adding a second Brainrot has a chance to give more.",
            "Tell your friend to join you.",
            "Click the Find Players button and wait.",
        },
        note = "If the player joins but doesn't show any Brainrot, please just wait. Blocking them will possibly get you banned.",
    },
    ["Kev Method"] = {
        steps = {
            "Requires 3 Brainrots worth 25M+ each.",
            "All of them must be placed on the first floor.",
            "After doing that, buy a random Brainrot.",
            "Click the Find Players button.",
        },
        note = "You must be solo for this method. Turning the Solo Player option off will get you banned.",
    },
    ["Slingy-New"] = {
        steps = {
            "Requires a 120M+ Brainrot and a sacrificial Brainrot worth 25M+.",
            "Place your best Brainrot on the second floor and your worst on the first floor.",
            "Sell the worst Brainrot.",
            "Click the Find Players button.",
        },
        note = "You must be solo for this method. Turning the Solo Player option off will get you banned.",
    },
    ["Custom Method"] = {
        steps  = {},
        note   = "This is where you create your own custom method. The minimum Brainrot required is 25M+.",
        custom = true,
    },
    ["FragV2"] = {
        steps = {
            "Requires a Brainrot worth 65M or more.",
            "You must have at least 3 Brainrots total.",
            "Place one Brainrot on the first floor, one on the second floor, and one on the third floor.",
            "Your best Brainrot should be placed on the first floor.",
            "Buy a random Brainrot, then immediately sell it.",
            "If done correctly, you are more likely to encounter players with high-value Brainrots.",
        },
        note = "You must be solo for this method. Turning the Solo Player option off will get you banned.",
    },
    ["Tide Method"] = {
        steps = {
            "Requires a Brainrot worth 35M or more.",
            "Place exactly 2 Brainrots on the second floor.",
            "The two Brainrots must be placed directly next to each other.",
            "You may now click the Find Players button.",
        },
        note = "You must be solo for this method. Turning the Solo Player option off will get you banned.",
    },
}

-- Mutation badge colors  { background Color3, bgTransparency, text Color3 }
local MUT_COLORS = {
    Gold        = { Color3.fromRGB(251,191,36),  0.65, Color3.fromRGB(146,64,14)   },
    Diamond     = { Color3.fromRGB(125,211,252), 0.45, Color3.fromRGB(7,89,133)    },
    Bloodrot    = { Color3.fromRGB(248,113,113), 0.45, Color3.fromRGB(153,27,27)   },
    Candy       = { Color3.fromRGB(244,114,182), 0.45, Color3.fromRGB(157,23,77)   },
    Lava        = { Color3.fromRGB(249,115,22),  0.45, Color3.fromRGB(194,65,12)   },
    Galaxy      = { Color3.fromRGB(76,29,149),   0,    Color3.fromRGB(233,213,255) },
    ["Yin Yang"]= { Color3.fromRGB(26,26,26),    0,    Color3.fromRGB(249,250,251) },
    Radioactive = { Color3.fromRGB(74,222,128),  0.35, Color3.fromRGB(20,83,45)    },
    Cursed      = { Color3.fromRGB(91,33,182),   0,    Color3.fromRGB(233,213,255) },
    Rainbow     = { Color3.fromRGB(251,113,133), 0,    Color3.fromRGB(255,255,255) },
}

-- Trait pill colors  { background Color3, text Color3 }
local TRAIT_COLORS = {
    Fire              = { Color3.fromRGB(254,215,170), Color3.fromRGB(194,65,12)   },
    Brazil            = { Color3.fromRGB(187,247,208), Color3.fromRGB(21,128,61)   },
    Fireworks         = { Color3.fromRGB(233,213,255), Color3.fromRGB(126,34,206)  },
    Nyan              = { Color3.fromRGB(252,231,243), Color3.fromRGB(190,24,93)   },
    Lightning         = { Color3.fromRGB(254,249,195), Color3.fromRGB(161,98,7)    },
    Indonesian        = { Color3.fromRGB(254,226,226), Color3.fromRGB(185,28,28)   },
    Sombrero          = { Color3.fromRGB(254,243,199), Color3.fromRGB(146,64,14)   },
    Disco             = { Color3.fromRGB(240,171,252), Color3.fromRGB(162,28,175)  },
    Glitched          = { Color3.fromRGB(207,250,254), Color3.fromRGB(14,116,144)  },
    ["Crab Claw"]     = { Color3.fromRGB(255,237,213), Color3.fromRGB(194,65,12)   },
    Zombie            = { Color3.fromRGB(209,250,229), Color3.fromRGB(6,95,70)     },
    Bubblegum         = { Color3.fromRGB(252,231,243), Color3.fromRGB(157,23,77)   },
    ["Comet-struck"]  = { Color3.fromRGB(224,231,255), Color3.fromRGB(55,48,163)   },
    UFO               = { Color3.fromRGB(204,251,241), Color3.fromRGB(15,118,110)  },
    Strawberry        = { Color3.fromRGB(254,205,211), Color3.fromRGB(190,18,60)   },
    Meowl             = { Color3.fromRGB(237,233,254), Color3.fromRGB(91,33,182)   },
    Skibidi           = { Color3.fromRGB(204,251,241), Color3.fromRGB(13,148,136)  },
    Reindeer          = { Color3.fromRGB(254,243,199), Color3.fromRGB(120,53,15)   },
    ["2026"]          = { Color3.fromRGB(219,234,254), Color3.fromRGB(29,78,216)   },
    ["Jack O'Lantern"]= { Color3.fromRGB(255,237,213), Color3.fromRGB(194,65,12)   },
    ["Santa Hat"]     = { Color3.fromRGB(254,226,226), Color3.fromRGB(153,27,27)   },
    ["RIP Tombstone"] = { Color3.fromRGB(243,244,246), Color3.fromRGB(55,65,81)    },
    ["Witching Hour"] = { Color3.fromRGB(237,233,254), Color3.fromRGB(109,40,217)  },
    Extinct           = { Color3.fromRGB(254,243,199), Color3.fromRGB(146,64,14)   },
    ["10B"]           = { Color3.fromRGB(254,249,195), Color3.fromRGB(133,77,14)   },
    Snowy             = { Color3.fromRGB(239,246,255), Color3.fromRGB(30,64,175)   },
    Rose              = { Color3.fromRGB(255,228,230), Color3.fromRGB(159,18,57)   },
    Sleepy            = { Color3.fromRGB(237,233,254), Color3.fromRGB(76,29,149)   },
    Wet               = { Color3.fromRGB(224,242,254), Color3.fromRGB(3,105,161)   },
}

-- --- HELPERS -----------------------------------------------------------------

local function weightedRandom(items)
    local total = 0
    for _, item in ipairs(items) do total += (item.weight or 1) end
    local r = math.random() * total
    for _, item in ipairs(items) do
        r -= (item.weight or 1)
        if r <= 0 then return item end
    end
    return items[#items]
end

local function pickTrait()
    local r = math.random() * 100
    if r < 0.25 then
        return TRAITS_SUPER_RARE[math.random(#TRAITS_SUPER_RARE)]
    elseif r < 1 then
        return TRAITS_RARE[math.random(#TRAITS_RARE)]
    else
        return TRAITS_COMMON[math.random(#TRAITS_COMMON)]
    end
end

local function pickTraitCount()
    local r = math.random() * 100
    if     r < 78.4999 then return 0
    elseif r < 90.9999 then return math.random(1, 2)
    elseif r < 96.4999 then return math.random(3, 4)
    elseif r < 99.9999 then return math.random(4, 5)
    else                     return 6
    end
end

local function pickBrainrot(userMax)
    userMax = userMax or 0
    local weights
    if userMax >= 100e6 then
        weights = {
            { min=282500,    max=900000,    weight=5  },
            { min=900001,    max=2250000,   weight=8  },
            { min=2250001,   max=7500000,   weight=14 },
            { min=7500001,   max=20000000,  weight=20 },
            { min=20000001,  max=100000000, weight=28 },
            { min=100000001, max=math.huge, weight=25 },
        }
    elseif userMax >= 20e6 then
        weights = {
            { min=282500,    max=900000,    weight=15 },
            { min=900001,    max=2250000,   weight=18 },
            { min=2250001,   max=7500000,   weight=22 },
            { min=7500001,   max=20000000,  weight=24 },
            { min=20000001,  max=100000000, weight=16 },
            { min=100000001, max=math.huge, weight=5  },
        }
    elseif userMax >= 7.5e6 then
        weights = {
            { min=282500,    max=900000,    weight=25 },
            { min=900001,    max=2250000,   weight=28 },
            { min=2250001,   max=7500000,   weight=26 },
            { min=7500001,   max=20000000,  weight=15 },
            { min=20000001,  max=100000000, weight=5  },
            { min=100000001, max=math.huge, weight=1  },
        }
    else
        weights = {
            { min=282500,    max=900000,    weight=63.75 },
            { min=900001,    max=2250000,   weight=17.5  },
            { min=2250001,   max=7500000,   weight=10.5  },
            { min=7500001,   max=20000000,  weight=5.75  },
            { min=20000001,  max=100000000, weight=2     },
            { min=100000001, max=math.huge, weight=0.5   },
        }
    end

    local tier = weightedRandom(weights)
    local pool = {}
    for _, br in ipairs(ALL_BRAINROTS) do
        if br.income >= tier.min and br.income <= tier.max then
            table.insert(pool, br)
        end
    end
    if #pool == 0 then return ALL_BRAINROTS[math.random(#ALL_BRAINROTS)] end
    return pool[math.random(#pool)]
end

local function calcIncome(base, mutation, traits)
    -- Correct formula (verified in-game):
    --   Mutation always contributes at full multiplier.
    --   Traits lose 1√ó per position: trait[1] = mult, trait[2] = mult-1, trait[3] = mult-2, etc.
    --   When a real mutation exists, trait[1] already starts at -1 because mutation occupies "slot 0".
    --   Example: Bacuru (24M) + Cursed (9√ó) + Fire (6√ó)
    --     = 24M√ó9 + 24M√ó(6-1) = 216M + 120M = 336M  ‚úì
    --   Example: Fragrama (100M) + Strawberry (8√ó) + Taco (2√ó), no mutation
    --     = 100M√ó1 + 100M√ó8 + 100M√ó(2-1) = 100M + 800M + 100M = 1000M = 1B/s  ‚úì
    local hasMutation = mutation.name ~= nil
    local total = base * mutation.mult
    for i, t in ipairs(traits) do
        -- With a real mutation: trait i has reduction = i (mutation fills slot 0)
        -- Without mutation: trait i has reduction = i - 1 (first trait has no reduction)
        local reduction = hasMutation and i or (i - 1)
        local effectiveMult = math.max(0, t.mult - reduction)
        total = total + base * effectiveMult
    end
    return total
end

local function fmtNum(n)
    -- Formats e.g. 1.25 ? "1.25", 100 ? "100"
    local s = string.format("%.2f", n)
    return s:gsub("%.?0+$", "")
end

local function fmtIncome(n)
    if     n >= 1e12 then return fmtNum(n/1e12).."T/s"
    elseif n >= 1e9  then return fmtNum(n/1e9).."B/s"
    elseif n >= 1e6  then return fmtNum(n/1e6).."M/s"
    elseif n >= 1e3  then return fmtNum(n/1e3).."K/s"
    else                  return math.floor(n).."/s"
    end
end

local function generateResult(userMax)
    local fs = forceState
    local username
    if fs and fs.enabled and fs.username and fs.username ~= "" then
        username = fs.username
    else
        local user = USERNAMES[math.random(math.max(1, #USERNAMES))]
        username = user and user.name or "Unknown"
    end
    local brainrot, mutation, traits

    if fs and fs.enabled then
        -- Brainrot lookup ‚Äî word-based matching handles names with mutation prefixes
        -- e.g. user types "Garama and Madudung", list has "[Candy][Taco] Garama and Madudung"
        if fs.brainrot and fs.brainrot ~= "" then
            local input = fs.brainrot:lower()

            -- Tier 1: exact case-insensitive match
            for _, br in ipairs(ALL_BRAINROTS) do
                if br.name:lower() == input then brainrot = br; break end
            end

            -- Tier 2: normalized ‚Äî strip non-alphanumeric, collapse spaces, compare
            if not brainrot then
                local wantNorm = input:gsub("[^%a%d%s]", ""):gsub("%s+", " "):match("^%s*(.-)%s*$")
                for _, br in ipairs(ALL_BRAINROTS) do
                    local norm = br.name:lower():gsub("[^%a%d%s]", ""):gsub("%s+", " "):match("^%s*(.-)%s*$")
                    if norm == wantNorm then brainrot = br; break end
                end
            end

            -- Tier 3: ALL significant words from user input found anywhere in brainrot name
            -- Strips mutation prefixes like [Candy][Taco] automatically
            if not brainrot then
                local words = {}
                for w in input:gsub("[^%a%d%s]", " "):gmatch("%S+") do
                    if #w >= 3 then table.insert(words, w) end  -- skip short words (of, a, etc)
                end
                if #words > 0 then
                    for _, br in ipairs(ALL_BRAINROTS) do
                        local bNorm = br.name:lower():gsub("[^%a%d%s]", " ")
                        local allFound = true
                        for _, w in ipairs(words) do
                            if not bNorm:find(w, 1, true) then allFound = false; break end
                        end
                        if allFound then brainrot = br; break end
                    end
                end
            end

            -- Tier 4: any word from user input appears in brainrot name (partial)
            if not brainrot then
                for _, br in ipairs(ALL_BRAINROTS) do
                    local bNorm = br.name:lower():gsub("[^%a%d%s]", " ")
                    for w in input:gsub("[^%a%d%s]", " "):gmatch("%S+") do
                        if #w >= 4 and bNorm:find(w, 1, true) then
                            brainrot = br; break
                        end
                    end
                    if brainrot then break end
                end
            end
        end
        brainrot = brainrot or pickBrainrot(userMax)

        -- Mutation
        if fs.mutation then
            for _, m in ipairs(MUTATIONS) do
                if m.name == fs.mutation then mutation = m; break end
            end
        end
        mutation = mutation or weightedRandom(MUTATIONS)

        -- Traits
        if fs.traits == nil then
            -- random
            local count = pickTraitCount()
            traits = {}
            local used = {}
            for i = 1, count do
                local t; local tries = 0
                repeat t = pickTrait(); tries += 1
                until not used[t.name] or tries >= 20
                used[t.name] = true
                table.insert(traits, t)
            end
        elseif #fs.traits == 0 then
            traits = {}
        else
            traits = {}
            local allTraits = {}
            for _, t in ipairs(TRAITS_SUPER_RARE) do table.insert(allTraits, t) end
            for _, t in ipairs(TRAITS_RARE)       do table.insert(allTraits, t) end
            for _, t in ipairs(TRAITS_COMMON)     do table.insert(allTraits, t) end
            for _, name in ipairs(fs.traits) do
                for _, t in ipairs(allTraits) do
                    if t.name:lower() == name:lower() then
                        table.insert(traits, t); break
                    end
                end
            end
            if #traits == 0 then
                local count = pickTraitCount(); local used = {}
                for i = 1, count do
                    local t; local tries = 0
                    repeat t = pickTrait(); tries += 1
                    until not used[t.name] or tries >= 20
                    used[t.name] = true; table.insert(traits, t)
                end
            end
        end
    else
        brainrot = pickBrainrot(userMax)
        mutation = weightedRandom(MUTATIONS)
        local count = pickTraitCount()
        traits = {}
        local used = {}
        for i = 1, count do
            local t; local tries = 0
            repeat t = pickTrait(); tries += 1
            until not used[t.name] or tries >= 20
            used[t.name] = true
            table.insert(traits, t)
        end
    end

    return {
        username = username,
        brainrot = brainrot,
        mutation = mutation,
        traits   = traits,
        income   = calcIncome(brainrot.income, mutation, traits),
    }
end

local function parseUserBrainrots(text)
    local results = {}
    local mults   = { K=1e3, M=1e6, B=1e9, T=1e12 }
    for line in (text .. "\n"):gmatch("([^\n]*)\n") do
        line = trim(line)
        if line ~= "" then
            local found = false
            for _, br in ipairs(ALL_BRAINROTS) do
                if line:lower():find(br.name:lower(), 1, true) then
                    table.insert(results, { name = br.name, income = br.income })
                    found = true
                    break
                end
            end
            if not found then
                local numStr, suf = line:match("([%d%.]+)([KMBTkmbt])")
                if numStr and suf then
                    local income = tonumber(numStr) * (mults[suf:upper()] or 1)
                    local rawName = line:gsub("%[.-%]", ""):match("^(.-)%s*[-?]") or line
                    table.insert(results, { name = trim(rawName), income = income })
                end
            end
        end
    end
    return results
end

local function getPossibleDrops(userBRs)
    if #userBRs == 0 then return {} end
    local maxIncome = 0
    for _, b in ipairs(userBRs) do
        if b.income > maxIncome then maxIncome = b.income end
    end
    local tiers = {
        { min = 0,         max = 900000    },
        { min = 900000,    max = 2250000   },
        { min = 2250000,   max = 7500000   },
        { min = 7500000,   max = 20000000  },
        { min = 20000000,  max = 100000000 },
        { min = 100000000, max = math.huge },
    }
    local idx = 1
    for i, t in ipairs(tiers) do
        if maxIncome >= t.min and (t.max == math.huge or maxIncome < t.max) then
            idx = i; break
        end
    end
    local lo = math.max(1, idx - 1)
    local hi = math.min(#tiers, idx + 1)
    local drops = {}
    for _, br in ipairs(ALL_BRAINROTS) do
        for i = lo, hi do
            local t = tiers[i]
            if br.income >= t.min and (t.max == math.huge or br.income < t.max) then
                table.insert(drops, br)
                break
            end
        end
    end
    return drops
end

-- --- UI FACTORY --------------------------------------------------------------

local C = {
    blue9  = Color3.fromRGB(30,  58,  138),
    blue8  = Color3.fromRGB(30,  64,  175),
    blue6  = Color3.fromRGB(37,  99,  235),
    blue3  = Color3.fromRGB(147, 197, 253),
    blue2  = Color3.fromRGB(191, 219, 254),
    blue1  = Color3.fromRGB(219, 234, 254),
    blueBg = Color3.fromRGB(239, 246, 255),
    sec    = Color3.fromRGB(147, 180, 216),
    white  = Color3.fromRGB(255, 255, 255),
    yellow = Color3.fromRGB(234, 179, 8),
    green  = Color3.fromRGB(34,  197, 94),
    red    = Color3.fromRGB(239, 68,  68),
    purple = Color3.fromRGB(124, 58,  237),
    warn   = Color3.fromRGB(146, 102, 10),
    border = Color3.fromRGB(186, 219, 255),
}

local function make(cls, props, parent)
    local inst = Instance.new(cls)
    for k, v in pairs(props or {}) do inst[k] = v end
    if parent then inst.Parent = parent end
    return inst
end

local function corner(r, inst)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r)
    c.Parent = inst
end

local function pad(t, b, l, r, inst)
    local p = Instance.new("UIPadding")
    p.PaddingTop    = UDim.new(0, t)
    p.PaddingBottom = UDim.new(0, b)
    p.PaddingLeft   = UDim.new(0, l)
    p.PaddingRight  = UDim.new(0, r)
    p.Parent = inst
end

local function vlist(inst, spacing)
    local l = Instance.new("UIListLayout")
    l.FillDirection       = Enum.FillDirection.Vertical
    l.HorizontalAlignment = Enum.HorizontalAlignment.Left
    l.VerticalAlignment   = Enum.VerticalAlignment.Top
    l.SortOrder           = Enum.SortOrder.LayoutOrder
    l.Padding             = UDim.new(0, spacing or 0)
    l.Parent = inst
    return l
end

local function hlist(inst, spacing)
    local l = Instance.new("UIListLayout")
    l.FillDirection       = Enum.FillDirection.Horizontal
    l.HorizontalAlignment = Enum.HorizontalAlignment.Left
    l.VerticalAlignment   = Enum.VerticalAlignment.Center
    l.SortOrder           = Enum.SortOrder.LayoutOrder
    l.Wraps               = true
    l.Padding             = UDim.new(0, spacing or 0)
    l.Parent = inst
    return l
end

local function stroke(color, thickness, inst)
    local s = Instance.new("UIStroke")
    s.Color          = color or C.border
    s.Thickness      = thickness or 1
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = inst
    return s
end

local function tw(inst, props, t, style)
    TweenService:Create(inst,
        TweenInfo.new(t or 0.25, style or Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        props):Play()
end

local function divider(parent, order)
    return make("Frame", {
        Size                 = UDim2.new(1, 0, 0, 1),
        BackgroundColor3     = C.border,
        BackgroundTransparency = 0.55,
        BorderSizePixel      = 0,
        LayoutOrder          = order or 0,
    }, parent)
end

-- --- REMOVE OLD GUI ----------------------------------------------------------

if gui:FindFirstChild("TideHub") then gui.TideHub:Destroy() end

local sg = make("ScreenGui", {
    Name              = "TideHub",
    ResetOnSpawn      = false,
    ZIndexBehavior    = Enum.ZIndexBehavior.Sibling,
    IgnoreGuiInset    = true,   -- covers FULL screen including top bar
    DisplayOrder      = 10,
}, gui)

-- Permanent small reopen button (sits on sg, always in front, only visible when menu is closed)
local reopenBtn = make("TextButton", {
    Size             = UDim2.new(0, 28, 0, 28),
    Position         = UDim2.new(0, 8, 0, 8),
    BackgroundColor3 = C.blue3,
    BorderSizePixel  = 0,
    Text             = "T",
    Font             = Enum.Font.GothamBold,
    TextSize         = 13,
    TextColor3       = C.white,
    AutoButtonColor  = false,
    ZIndex           = 200,
    Visible          = false,
}, sg)
corner(8, reopenBtn)

-- ---------------------------------------------------------------------------
--  SPLASH
-- ---------------------------------------------------------------------------

local splash = make("Frame", {
    Size             = UDim2.fromScale(1, 1),
    BackgroundColor3 = Color3.fromRGB(240, 246, 255),
    BorderSizePixel  = 0,
    ZIndex           = 10,
}, sg)
do
    local g = Instance.new("UIGradient")
    g.Color    = ColorSequence.new({
        ColorSequenceKeypoint.new(0,   Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(224, 236, 255)),
        ColorSequenceKeypoint.new(1,   Color3.fromRGB(204, 222, 255)),
    })
    g.Rotation = 145
    g.Parent   = splash
end

-- sCenter: fully relative layout so it fills any screen size on any device
local sCenter = make("Frame", {
    AnchorPoint      = Vector2.new(0.5, 0.5),
    Size             = UDim2.fromScale(1, 1),
    Position         = UDim2.fromScale(0.5, 0.5),
    BackgroundTransparency = 1,
}, splash)

-- "Tide" - takes up ~30% of screen height, centered vertically at 35%
local tideLabel = make("TextLabel", {
    AnchorPoint      = Vector2.new(0.5, 0),
    Size             = UDim2.new(0.8, 0, 0.25, 0),
    Position         = UDim2.new(0.5, 0, 0.28, 0),
    BackgroundTransparency = 1,
    Text             = "Tide",
    Font             = Enum.Font.GothamBold,
    TextSize         = 80,
    TextScaled       = true,
    TextColor3       = C.blue9,
    TextXAlignment   = Enum.TextXAlignment.Center,
    TextTransparency = 1,
}, sCenter)

local subLabel = make("TextLabel", {
    AnchorPoint      = Vector2.new(0.5, 0),
    Size             = UDim2.new(0.7, 0, 0.055, 0),
    Position         = UDim2.new(0.5, 0, 0.55, 0),
    BackgroundTransparency = 1,
    Text             = "AUTO MOREIRA",
    Font             = Enum.Font.GothamBold,
    TextSize         = 14,
    TextScaled       = true,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Center,
    TextTransparency = 1,
}, sCenter)

local tagLabel = make("TextLabel", {
    AnchorPoint      = Vector2.new(0.5, 0),
    Size             = UDim2.new(0.7, 0, 0.045, 0),
    Position         = UDim2.new(0.5, 0, 0.615, 0),
    BackgroundTransparency = 1,
    Text             = "The clean way to play.",
    Font             = Enum.Font.Gotham,
    TextSize         = 17,
    TextScaled       = true,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Center,
    TextTransparency = 1,
}, sCenter)

local barBg = make("Frame", {
    AnchorPoint      = Vector2.new(0.5, 0),
    Size             = UDim2.new(0.55, 0, 0, 3),
    Position         = UDim2.new(0.5, 0, 0.70, 0),
    BackgroundColor3 = C.blue2,
    BackgroundTransparency = 0.5,
    BorderSizePixel  = 0,
}, sCenter)
corner(2, barBg)

local bar = make("Frame", {
    Size             = UDim2.new(0, 0, 1, 0),
    BackgroundColor3 = C.blue6,
    BorderSizePixel  = 0,
}, barBg)
corner(2, bar)

local dotFrame = make("Frame", {
    AnchorPoint      = Vector2.new(0.5, 0),
    Size             = UDim2.new(0, 54, 0, 10),
    Position         = UDim2.new(0.5, 0, 0.75, 0),
    BackgroundTransparency = 1,
}, sCenter)

local dots = {}
for i = 1, 3 do
    local d = make("Frame", {
        Size             = UDim2.new(0, 6, 0, 6),
        Position         = UDim2.new(0, (i - 1) * 24, 0.5, -3),
        BackgroundColor3 = C.blue3,
        BackgroundTransparency = 0.4,
        BorderSizePixel  = 0,
    }, dotFrame)
    corner(99, d)
    dots[i] = d
end

-- ---------------------------------------------------------------------------
--  MAIN  (CanvasGroup = entire UI tree fades uniformly with GroupTransparency)
-- ---------------------------------------------------------------------------

local guiRoot = Instance.new("CanvasGroup")
guiRoot.Size                 = UDim2.new(0, 285, 0, 345)
guiRoot.AnchorPoint          = Vector2.new(0.5, 0.5)
guiRoot.Position             = UDim2.new(0.5, 0, 0.5, 0)
guiRoot.BackgroundTransparency = 1
guiRoot.BorderSizePixel      = 0
guiRoot.GroupTransparency    = 0
guiRoot.Visible              = false   -- shown after splash
guiRoot.Parent               = sg

-- toggleBtn lives on sg so GroupTransparency fade NEVER touches it
local toggleBtn = make("TextButton", {
    Size             = UDim2.new(0, 48, 0, 48),
    Position         = UDim2.new(0, 10, 0.5, -24),
    AnchorPoint      = Vector2.new(0, 0),
    BackgroundColor3 = C.blue6,
    BorderSizePixel  = 0,
    Text             = "T",
    Font             = Enum.Font.GothamBold,
    TextSize         = 18,
    TextColor3       = C.white,
    AutoButtonColor  = false,
    ZIndex           = 200,
    Visible          = false,   -- hidden during splash, shown after
}, sg)
corner(14, toggleBtn)

-- Draggable toggle button
do
    local tDragging, tDragStart, tStartPos = false, nil, nil
    local moved = false
    toggleBtn.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.Touch
        or inp.UserInputType == Enum.UserInputType.MouseButton1 then
            tDragging  = true
            tDragStart = inp.Position
            tStartPos  = toggleBtn.Position
            moved      = false
        end
    end)
    UserInputService.InputChanged:Connect(function(inp)
        if not tDragging then return end
        if inp.UserInputType == Enum.UserInputType.Touch
        or inp.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = inp.Position - tDragStart
            if math.abs(delta.X) > 4 or math.abs(delta.Y) > 4 then moved = true end
            toggleBtn.Position = UDim2.new(
                tStartPos.X.Scale, tStartPos.X.Offset + delta.X,
                tStartPos.Y.Scale, tStartPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.Touch
        or inp.UserInputType == Enum.UserInputType.MouseButton1 then
            tDragging = false
            -- If it was a real drag, don't fire click
            if moved then moved = false end
        end
    end)
end

-- Drag handle ? transparent strip at top of guiRoot
local dragHandle = make("TextButton", {
    Size             = UDim2.new(1, 0, 0, 40),
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    Text             = "",
    AutoButtonColor  = false,
    ZIndex           = 3,
}, guiRoot)

do
    local dragging, dragStart, startPos = false, nil, nil
    dragHandle.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.Touch
        or inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging  = true
            dragStart = inp.Position
            startPos  = guiRoot.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(inp)
        if not dragging then return end
        if inp.UserInputType == Enum.UserInputType.Touch
        or inp.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = inp.Position - dragStart
            guiRoot.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.Touch
        or inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
end

local main = make("Frame", {
    Size             = UDim2.fromScale(1, 1),
    BackgroundColor3 = Color3.fromRGB(242, 247, 255),
    BorderSizePixel  = 0,
    Visible          = true,
    ClipsDescendants = true,
}, guiRoot)
corner(12, main)
do
    local g = Instance.new("UIGradient")
    g.Color    = ColorSequence.new({
        ColorSequenceKeypoint.new(0,   Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(0.4, Color3.fromRGB(224, 236, 255)),
        ColorSequenceKeypoint.new(1,   Color3.fromRGB(204, 222, 255)),
    })
    g.Rotation = 150
    g.Parent   = main
end

local scroll = make("ScrollingFrame", {
    Size                 = UDim2.fromScale(1, 1),
    BackgroundTransparency = 1,
    BorderSizePixel      = 0,
    ScrollBarThickness   = 0,
    CanvasSize           = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize  = Enum.AutomaticSize.Y,
}, main)

-- Center column ? 88% screen width, hard cap 300px (Samsung Galaxy A14 = ~412px wide)
local col = make("Frame", {
    AnchorPoint      = Vector2.new(0.5, 0),
    Size             = UDim2.new(0.88, 0, 0, 0),
    Position         = UDim2.new(0.5, 0, 0, 8),
    AutomaticSize    = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
}, scroll)
do
    local constraint = Instance.new("UISizeConstraint")
    constraint.MaxSize = Vector2.new(300, math.huge)
    constraint.Parent = col
end
vlist(col, 0)
pad(0, 12, 0, 0, col)

-- Title
local titleBlock = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 34),
    BackgroundTransparency = 1,
    LayoutOrder      = 1,
}, col)
make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 22),
    BackgroundTransparency = 1,
    Text             = "Tide",
    Font             = Enum.Font.GothamBold,
    TextSize         = 20,
    TextColor3       = C.blue9,
    TextXAlignment   = Enum.TextXAlignment.Center,
}, titleBlock)
make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 12),
    Position         = UDim2.new(0, 0, 0, 23),
    BackgroundTransparency = 1,
    Text             = "AUTO MOREIRA",
    Font             = Enum.Font.GothamBold,
    TextSize         = 8,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Center,
}, titleBlock)

-- Tab bar (admin only sees it ? for everyone else skip straight to panel)
local activeTab = "main"
local tabBar, tabMain, tabAdmin

if IS_ADMIN then
    tabBar = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 28),
        BackgroundColor3 = C.blue1,
        BackgroundTransparency = 0.3,
        BorderSizePixel = 0,
        LayoutOrder   = 2,
    }, col)
    corner(8, tabBar)
    stroke(C.border, 1, tabBar)
    hlist(tabBar, 0)

    tabMain = make("TextButton", {
        Size             = UDim2.new(0.5, 0, 1, 0),
        BackgroundColor3 = C.blue6,
        BackgroundTransparency = 0,
        BorderSizePixel  = 0,
        Text             = "Main",
        Font             = Enum.Font.GothamBold,
        TextSize         = 11,
        TextColor3       = C.white,
        AutoButtonColor  = false,
        LayoutOrder      = 1,
    }, tabBar)
    corner(8, tabMain)

    tabAdmin = make("TextButton", {
        Size             = UDim2.new(0.5, 0, 1, 0),
        BackgroundColor3 = C.blue1,
        BackgroundTransparency = 1,
        BorderSizePixel  = 0,
        Text             = "Force",
        Font             = Enum.Font.GothamBold,
        TextSize         = 11,
        TextColor3       = C.blue8,
        AutoButtonColor  = false,
        LayoutOrder      = 2,
    }, tabBar)
    corner(8, tabAdmin)
end

-- Force textbox references ‚Äî declared here so findBtn can read them directly
-- (assigned inside IS_ADMIN block below)
local fPlayerBox_ref, fBrBox_ref, fTraitBox_ref = nil, nil, nil

-- Panel (Main tab content)
local panel = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 0),
    AutomaticSize    = Enum.AutomaticSize.Y,
    BackgroundColor3 = C.white,
    BackgroundTransparency = 0.2,
    BorderSizePixel  = 0,
    LayoutOrder      = 3,
}, col)
corner(10, panel)
stroke(C.border, 1, panel)
pad(10, 12, 10, 10, panel)
vlist(panel, 8)

-- -- Section: Method -----------------------------------------------------------

local methodSec = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    LayoutOrder   = 1,
}, panel)
vlist(methodSec, 8)

make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 12),
    BackgroundTransparency = 1,
    Text             = "SELECT METHOD",
    Font             = Enum.Font.GothamBold,
    TextSize         = 9,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Left,
    LayoutOrder      = 1,
}, methodSec)

local dropBtn = make("TextButton", {
    Size             = UDim2.new(1, 0, 0, 34),
    BackgroundColor3 = C.blueBg,
    BackgroundTransparency = 0.3,
    BorderSizePixel  = 0,
    Text             = "",
    AutoButtonColor  = false,
    LayoutOrder      = 2,
}, methodSec)
corner(10, dropBtn)
stroke(C.border, 1, dropBtn)

local dropLbl = make("TextLabel", {
    Size             = UDim2.new(1, -32, 1, 0),
    Position         = UDim2.new(0, 11, 0, 0),
    BackgroundTransparency = 1,
    Text             = "Choose a method?",
    Font             = Enum.Font.Gotham,
    TextSize         = 12,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Left,
}, dropBtn)

local dropArrow = make("TextLabel", {
    Size             = UDim2.new(0, 22, 0, 22),
    Position         = UDim2.new(1, -30, 0.5, -11),
    BackgroundTransparency = 1,
    Text             = "v",
    Font             = Enum.Font.GothamBold,
    TextSize         = 13,
    TextColor3       = C.sec,
}, dropBtn)

-- Transparent backdrop ? closes dropdown when clicking outside
-- Must be parented to sg (behind dropList which is also on sg)
local dropBackdrop = make("TextButton", {
    Size             = UDim2.fromScale(1, 1),
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    Text             = "",
    ZIndex           = 49,
    Visible          = false,
}, sg)

-- Dropdown overlay ? parented to sg so it floats above everything
-- ClipsDescendants FALSE: Roblox clips to rectangle, NOT rounded corners,
-- so we keep it off and make button BGs transparent instead.
-- The container's own UICorner + background provide the rounded look.
local dropList = make("Frame", {
    Size             = UDim2.new(0, 1, 0, 0),
    AutomaticSize    = Enum.AutomaticSize.Y,
    BackgroundColor3 = C.white,
    BackgroundTransparency = 0,
    BorderSizePixel  = 0,
    Visible          = false,
    ZIndex           = 50,
}, sg)
corner(10, dropList)
stroke(C.border, 1, dropList)
vlist(dropList, 0)

local mBtns = {}
for i, m in ipairs(METHODS) do
    -- Transparent background: no square bleed past UICorner
    local btn = make("TextButton", {
        Size             = UDim2.new(1, 0, 0, 34),
        BackgroundTransparency = 1,
        BorderSizePixel  = 0,
        Text             = "  " .. m,
        Font             = Enum.Font.Gotham,
        TextSize         = 11,
        TextColor3       = Color3.fromRGB(59, 110, 168),
        TextXAlignment   = Enum.TextXAlignment.Left,
        AutoButtonColor  = false,
        ZIndex           = 51,
        LayoutOrder      = i * 2 - 1,
    }, dropList)
    mBtns[m] = btn
    if i < #METHODS then
        make("Frame", {
            Size             = UDim2.new(1, 0, 0, 1),
            BackgroundColor3 = C.border,
            BackgroundTransparency = 0.5,
            BorderSizePixel  = 0,
            ZIndex           = 51,
            LayoutOrder      = i * 2,
        }, dropList)
    end
end

-- -- Divider -------------------------------------------------------------------
divider(panel, 2)

-- -- Section: Solo Toggle -----------------------------------------------------

local soloSec = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    LayoutOrder   = 3,
}, panel)
vlist(soloSec, 8)

local soloRow = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 38),
    BackgroundTransparency = 1,
    LayoutOrder   = 1,
}, soloSec)

make("TextLabel", {
    Size             = UDim2.new(1, -52, 0, 18),
    BackgroundTransparency = 1,
    Text             = "Solo-Player Method",
    Font             = Enum.Font.GothamSemibold,
    TextSize         = 12,
    TextColor3       = C.blue9,
    TextXAlignment   = Enum.TextXAlignment.Left,
}, soloRow)

local soloSub = make("TextLabel", {
    Size             = UDim2.new(1, -52, 0, 15),
    Position         = UDim2.new(0, 0, 0, 20),
    BackgroundTransparency = 1,
    Text             = "Others can be in the server",
    Font             = Enum.Font.Gotham,
    TextSize         = 10,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Left,
}, soloRow)

local togBg = make("Frame", {
    Size             = UDim2.new(0, 42, 0, 24),
    Position         = UDim2.new(1, -42, 0.5, -12),
    BackgroundColor3 = C.blue3,
    BackgroundTransparency = 0.5,
    BorderSizePixel  = 0,
}, soloRow)
corner(99, togBg)

local togThumb = make("Frame", {
    Size             = UDim2.new(0, 16, 0, 16),
    Position         = UDim2.new(0, 4, 0.5, -8),
    BackgroundColor3 = C.white,
    BorderSizePixel  = 0,
}, togBg)
corner(99, togThumb)

-- Invisible button on toggle
local togHit = make("TextButton", {
    Size             = UDim2.fromScale(1, 1),
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    Text             = "",
    ZIndex           = 2,
}, togBg)

local soloWarnBox = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 0),
    AutomaticSize    = Enum.AutomaticSize.Y,
    BackgroundColor3 = Color3.fromRGB(254, 226, 226),
    BackgroundTransparency = 0.3,
    BorderSizePixel  = 0,
    Visible          = false,
    LayoutOrder      = 2,
}, soloSec)
corner(8, soloWarnBox)
pad(10, 10, 12, 12, soloWarnBox)
make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 0),
    AutomaticSize    = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    Text             = "Warning: Turning off Solo Player mode for this method may result in your account getting banned.",
    Font             = Enum.Font.Gotham,
    TextSize         = 12,
    TextColor3       = Color3.fromRGB(153, 27, 27),
    TextXAlignment   = Enum.TextXAlignment.Left,
    TextWrapped      = true,
}, soloWarnBox)

-- -- Divider -------------------------------------------------------------------
divider(panel, 4)

-- -- Section: Brainrots Input -------------------------------------------------

local brSec = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    LayoutOrder   = 5,
}, panel)
vlist(brSec, 8)

local brHdrRow = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 12),
    BackgroundTransparency = 1,
    LayoutOrder   = 1,
}, brSec)
make("TextLabel", {
    Size             = UDim2.new(0, 180, 1, 0),
    BackgroundTransparency = 1,
    Text             = "WHAT BRAINROTS DO I HAVE?",
    Font             = Enum.Font.GothamBold,
    TextSize         = 9,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Left,
}, brHdrRow)
make("TextLabel", {
    Size             = UDim2.new(0, 70, 1, 0),
    Position         = UDim2.new(0, 184, 0, 0),
    BackgroundTransparency = 1,
    Text             = "REQUIRED",
    Font             = Enum.Font.GothamBold,
    TextSize         = 9,
    TextColor3       = C.red,
    TextXAlignment   = Enum.TextXAlignment.Left,
}, brHdrRow)

local brBox = make("TextBox", {
    Size             = UDim2.new(1, 0, 0, 60),
    BackgroundColor3 = C.blueBg,
    BackgroundTransparency = 0.3,
    BorderSizePixel  = 0,
    Text             = "",
    PlaceholderText  = "e.g.\n[Candy][Taco] Garama and Madundung - 350M\nReindeer Tralala - 600K",
    PlaceholderColor3= C.sec,
    Font             = Enum.Font.Gotham,
    TextSize         = 11,
    TextColor3       = C.blue9,
    TextXAlignment   = Enum.TextXAlignment.Left,
    TextYAlignment   = Enum.TextYAlignment.Top,
    MultiLine        = true,
    ClearTextOnFocus = false,
    LayoutOrder      = 2,
}, brSec)
corner(10, brBox)
local brStroke = stroke(C.border, 1, brBox)
pad(10, 10, 12, 12, brBox)

-- Invisible touch-blocker ‚Äî shown when confirmed to prevent mobile tap-to-edit
local brBlocker = make("TextButton", {
    Size             = UDim2.fromScale(1, 1),
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    Text             = "",
    AutoButtonColor  = false,
    Visible          = false,
    ZIndex           = 5,
}, brBox)

-- Warning
local warnBox = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundColor3 = Color3.fromRGB(255, 243, 205),
    BackgroundTransparency = 0.4,
    BorderSizePixel = 0,
    LayoutOrder   = 3,
}, brSec)
corner(8, warnBox)
pad(10, 10, 12, 12, warnBox)
make("TextLabel", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    Text          = "Warning: Listing a Brainrot you don't actually have will possibly get your account banned due to the anticheat. This has been proven by multiple members of Tide.",
    Font          = Enum.Font.Gotham,
    TextSize      = 10,
    TextColor3    = C.warn,
    TextXAlignment= Enum.TextXAlignment.Left,
    TextWrapped   = true,
}, warnBox)

local confirmBtn = make("TextButton", {
    Size             = UDim2.new(1, 0, 0, 34),
    BackgroundColor3 = C.blue3,
    BorderSizePixel  = 0,
    Text             = "Select a method first",
    Font             = Enum.Font.GothamBold,
    TextSize         = 12,
    TextColor3       = C.sec,
    BackgroundTransparency = 0.6,
    AutoButtonColor  = false,
    LayoutOrder      = 4,
}, brSec)
corner(10, confirmBtn)

-- -- Divider -------------------------------------------------------------------
divider(panel, 6)

-- -- Section: Possible Drops ---------------------------------------------------

local dropsSec = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    LayoutOrder   = 7,
}, panel)
vlist(dropsSec, 8)

make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 12),
    BackgroundTransparency = 1,
    Text             = "BRAINROTS YOU COULD GET FROM PLAYERS",
    Font             = Enum.Font.GothamBold,
    TextSize         = 9,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Left,
    LayoutOrder      = 1,
}, dropsSec)

local dropsHint = make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 18),
    BackgroundTransparency = 1,
    Text             = "Enter your Brainrots above to see possible drops.",
    Font             = Enum.Font.Gotham,
    TextSize         = 11,
    TextColor3       = C.sec,
    TextTransparency = 0.35,
    TextXAlignment   = Enum.TextXAlignment.Left,
    LayoutOrder      = 2,
}, dropsSec)

local dropsList = make("ScrollingFrame", {
    Size                = UDim2.new(1, 0, 0, 120),
    BackgroundTransparency = 1,
    BorderSizePixel     = 0,
    ScrollBarThickness  = 0,
    CanvasSize          = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize = Enum.AutomaticSize.Y,
    Visible             = false,
    LayoutOrder         = 2,
}, dropsSec)
vlist(dropsList, 4)

-- -- Divider -------------------------------------------------------------------
divider(panel, 8)

-- -- Section: Find Player ------------------------------------------------------

local findSec = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    LayoutOrder   = 9,
}, panel)
vlist(findSec, 10)

local findBtn = make("TextButton", {
    Size             = UDim2.new(1, 0, 0, 36),
    BackgroundColor3 = C.blue3,
    BackgroundTransparency = 0.6,
    BorderSizePixel  = 0,
    Text             = "Confirm your Brainrots first",
    Font             = Enum.Font.GothamBold,
    TextSize         = 12,
    TextColor3       = C.sec,
    AutoButtonColor  = false,
    LayoutOrder      = 1,
}, findSec)
corner(12, findBtn)

-- Countdown strip
local cdFrame = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 46),
    BackgroundColor3 = C.blueBg,
    BackgroundTransparency = 0.2,
    BorderSizePixel  = 0,
    Visible          = false,
    LayoutOrder      = 2,
}, findSec)
corner(10, cdFrame)
stroke(C.border, 1, cdFrame)
pad(0, 0, 16, 16, cdFrame)

make("TextLabel", {
    Size             = UDim2.new(1, -50, 1, 0),
    BackgroundTransparency = 1,
    Text             = "Please Wait",
    Font             = Enum.Font.GothamSemibold,
    TextSize         = 14,
    TextColor3       = C.blue8,
    TextXAlignment   = Enum.TextXAlignment.Left,
}, cdFrame)
local cdLbl = make("TextLabel", {
    Size             = UDim2.new(0, 44, 1, 0),
    Position         = UDim2.new(1, -44, 0, 0),
    BackgroundTransparency = 1,
    Text             = "4",
    Font             = Enum.Font.GothamBold,
    TextSize         = 26,
    TextColor3       = C.blue6,
    TextXAlignment   = Enum.TextXAlignment.Right,
}, cdFrame)

-- Result card (built dynamically)
local resultCard = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 0),
    AutomaticSize    = Enum.AutomaticSize.Y,
    BackgroundColor3 = C.white,
    BackgroundTransparency = 0.1,
    BorderSizePixel  = 0,
    Visible          = false,
    LayoutOrder      = 3,
}, findSec)
corner(14, resultCard)
stroke(C.border, 1, resultCard)
pad(16, 16, 16, 16, resultCard)
vlist(resultCard, 8)

-- Footer
make("TextLabel", {
    Size             = UDim2.new(1, 0, 0, 28),
    BackgroundTransparency = 1,
    Text             = "Tide - Auto Moreira",
    Font             = Enum.Font.Gotham,
    TextSize         = 11,
    TextColor3       = C.sec,
    TextXAlignment   = Enum.TextXAlignment.Center,
    TextTransparency = 0.35,
    LayoutOrder      = 4,
}, col)

-- Session stats bar
local sessionStatsBar = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 24),
    BackgroundColor3 = C.blue1,
    BackgroundTransparency = 0.3,
    BorderSizePixel  = 0,
    LayoutOrder      = 5,
}, col)
corner(8, sessionStatsBar)
stroke(C.border, 1, sessionStatsBar)
local sessionStatsLbl = make("TextLabel", {
    Size             = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Text             = "Searches: 0   |   Best: ‚Äî",
    Font             = Enum.Font.GothamSemibold,
    TextSize          = 10,
    TextColor3       = C.blue8,
    TextXAlignment   = Enum.TextXAlignment.Center,
}, sessionStatsBar)

-- ---------------------------------------------------------------------------
--  ADMIN TAB  (only built if IS_ADMIN)
-- ---------------------------------------------------------------------------

local adminPanel

if IS_ADMIN then
    adminPanel = make("Frame", {
        Size             = UDim2.new(1, 0, 0, 0),
        AutomaticSize    = Enum.AutomaticSize.Y,
        BackgroundColor3 = C.white,
        BackgroundTransparency = 0.2,
        BorderSizePixel  = 0,
        LayoutOrder      = 5,
        Visible          = false,
    }, col)
    corner(10, adminPanel)
    stroke(C.border, 1, adminPanel)
    pad(10, 14, 10, 10, adminPanel)
    vlist(adminPanel, 10)

    -- Header
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 14),
        BackgroundTransparency = 1,
        Text             = "FORCE CONTROLS",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.purple,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 1,
    }, adminPanel)

    -- Force enable toggle row
    local forceRow = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 32),
        BackgroundTransparency = 1,
        LayoutOrder   = 2,
    }, adminPanel)

    make("TextLabel", {
        Size             = UDim2.new(1, -52, 0, 16),
        BackgroundTransparency = 1,
        Text             = "Force Next Result",
        Font             = Enum.Font.GothamSemibold,
        TextSize         = 12,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, forceRow)
    make("TextLabel", {
        Size             = UDim2.new(1, -52, 0, 14),
        Position         = UDim2.new(0, 0, 0, 17),
        BackgroundTransparency = 1,
        Text             = "Overrides next Find Player result",
        Font             = Enum.Font.Gotham,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, forceRow)

    local fTogBg = make("Frame", {
        Size             = UDim2.new(0, 42, 0, 24),
        Position         = UDim2.new(1, -42, 0.5, -12),
        BackgroundColor3 = C.blue3,
        BackgroundTransparency = 0.5,
        BorderSizePixel  = 0,
    }, forceRow)
    corner(99, fTogBg)
    local fTogThumb = make("Frame", {
        Size             = UDim2.new(0, 16, 0, 16),
        Position         = UDim2.new(0, 4, 0.5, -8),
        BackgroundColor3 = C.white,
        BorderSizePixel  = 0,
    }, fTogBg)
    corner(99, fTogThumb)
    local fTogHit = make("TextButton", {
        Size = UDim2.fromScale(1,1), BackgroundTransparency=1, BorderSizePixel=0, Text="", ZIndex=2
    }, fTogBg)

    -- Fields frame (shown when force is enabled)
    local forceFields = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        BackgroundTransparency = 1,
        LayoutOrder   = 3,
        Visible       = false,
    }, adminPanel)
    vlist(forceFields, 8)

    -- -- Player name ----------------------------------------------------------
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 11),
        BackgroundTransparency = 1,
        Text             = "PLAYER NAME  (blank = random)",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 0,
    }, forceFields)
    local fPlayerBox = make("TextBox", {
        Size             = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = C.blueBg,
        BackgroundTransparency = 0.3,
        BorderSizePixel  = 0,
        Text             = "",
        PlaceholderText  = "e.g. CoolPlayer99",
        PlaceholderColor3= C.sec,
        Font             = Enum.Font.Gotham,
        TextSize         = 11,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        LayoutOrder      = 1,
    }, forceFields)
    corner(8, fPlayerBox)
    stroke(C.border, 1, fPlayerBox)
    pad(0, 0, 10, 10, fPlayerBox)
    fPlayerBox_ref = fPlayerBox  -- expose to outer scope

    -- -- Brainrot input ------------------------------------------------------
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 11),
        BackgroundTransparency = 1,
        Text             = "BRAINROT NAME  (blank = random)",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 2,
    }, forceFields)

    local fBrBox = make("TextBox", {
        Size             = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = C.blueBg,
        BackgroundTransparency = 0.3,
        BorderSizePixel  = 0,
        Text             = "",
        PlaceholderText  = "e.g. Hydra Dragon Cannelloni",
        PlaceholderColor3= C.sec,
        Font             = Enum.Font.Gotham,
        TextSize         = 11,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        LayoutOrder      = 3,
    }, forceFields)
    corner(8, fBrBox)
    stroke(C.border, 1, fBrBox)
    pad(0, 0, 10, 10, fBrBox)
    fBrBox_ref = fBrBox  -- expose to outer scope

    -- -- Mutation picker -----------------------------------------------------
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 11),
        BackgroundTransparency = 1,
        Text             = "MUTATION  (blank = random)",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 3,
    }, forceFields)

    local mutNames = { "Random" }
    for _, m in ipairs(MUTATIONS) do
        if m.name then table.insert(mutNames, m.name) end
    end

    local fMutIdx = 1  -- 1 = random
    local fMutBtn = make("TextButton", {
        Size             = UDim2.new(1, 0, 0, 30),
        BackgroundColor3 = C.blueBg,
        BackgroundTransparency = 0.3,
        BorderSizePixel  = 0,
        Text             = "",
        AutoButtonColor  = false,
        LayoutOrder      = 5,
    }, forceFields)
    corner(8, fMutBtn)
    stroke(C.border, 1, fMutBtn)
    local fMutLbl = make("TextLabel", {
        Size             = UDim2.new(1, -28, 1, 0),
        Position         = UDim2.new(0, 10, 0, 0),
        BackgroundTransparency = 1,
        Text             = "Random",
        Font             = Enum.Font.Gotham,
        TextSize         = 11,
        TextColor3       = C.blue8,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, fMutBtn)
    make("TextLabel", {
        Size             = UDim2.new(0, 18, 0, 18),
        Position         = UDim2.new(1, -26, 0.5, -9),
        BackgroundTransparency = 1,
        Text             = "v",
        Font             = Enum.Font.GothamBold,
        TextSize         = 11,
        TextColor3       = C.sec,
    }, fMutBtn)

    -- Mutation dropdown: ScrollingFrame so user can scroll on mobile
    local fMutList = make("ScrollingFrame", {
        Size                 = UDim2.new(0, 1, 0, 150),
        BackgroundColor3     = C.white,
        BorderSizePixel      = 0,
        Visible              = false,
        ZIndex               = 60,
        ScrollBarThickness   = 3,
        ScrollBarImageColor3 = C.blue3,
        CanvasSize           = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize  = Enum.AutomaticSize.Y,
        ClipsDescendants     = true,
    }, sg)
    corner(8, fMutList)
    stroke(C.border, 1, fMutList)
    vlist(fMutList, 0)

    local fMutBtns = {}
    for i, nm in ipairs(mutNames) do
        local b = make("TextButton", {
            Size             = UDim2.new(1, 0, 0, 30),
            BackgroundTransparency = 1,
            BorderSizePixel  = 0,
            Text             = "  " .. nm,
            Font             = Enum.Font.Gotham,
            TextSize         = 11,
            TextColor3       = Color3.fromRGB(59, 110, 168),
            TextXAlignment   = Enum.TextXAlignment.Left,
            AutoButtonColor  = false,
            ZIndex           = 61,
            LayoutOrder      = i * 2 - 1,  -- odd: 1,3,5... interleaved with separators
        }, fMutList)
        fMutBtns[i] = b
        if i < #mutNames then
            make("Frame", { Size=UDim2.new(1,0,0,1), BackgroundColor3=C.border,
                BackgroundTransparency=0.5, BorderSizePixel=0, ZIndex=61, LayoutOrder=i*2 }, fMutList)
        end
    end

    local fMutOpen = false
    local function setFMut(open)
        fMutOpen = open
        if open then
            local abs = fMutBtn.AbsolutePosition
            local sz  = fMutBtn.AbsoluteSize
            fMutList.Position = UDim2.new(0, abs.X, 0, abs.Y + sz.Y + 3)
            fMutList.Size     = UDim2.new(0, sz.X, 0, 150)
            fMutList.Visible  = true
        else
            fMutList.Visible = false
        end
    end
    fMutBtn.MouseButton1Click:Connect(function() setFMut(not fMutOpen) end)
    for i, nm in ipairs(mutNames) do
        fMutBtns[i].MouseButton1Click:Connect(function()
            fMutIdx = i
            fMutLbl.Text = nm
            forceState.mutation = (nm == "Random") and nil or nm
            setFMut(false)
        end)
    end

    -- -- Trait input ---------------------------------------------------------
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 11),
        BackgroundTransparency = 1,
        Text             = "TRAITS  (comma-separated, blank = random)",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 6,
    }, forceFields)

    local fTraitBox = make("TextBox", {
        Size             = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = C.blueBg,
        BackgroundTransparency = 0.3,
        BorderSizePixel  = 0,
        Text             = "",
        PlaceholderText  = "e.g. Strawberry, Fire  (or blank)",
        PlaceholderColor3= C.sec,
        Font             = Enum.Font.Gotham,
        TextSize         = 11,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        LayoutOrder      = 7,
    }, forceFields)
    corner(8, fTraitBox)
    stroke(C.border, 1, fTraitBox)
    pad(0, 0, 10, 10, fTraitBox)
    fTraitBox_ref = fTraitBox  -- expose to outer scope

    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 0),
        AutomaticSize    = Enum.AutomaticSize.Y,
        BackgroundTransparency = 1,
        Text             = "No traits = random. 'none' = force no traits.",
        Font             = Enum.Font.Gotham,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
        TextWrapped      = true,
        LayoutOrder      = 8,
    }, forceFields)

    -- Apply button
    local fApplyWrapper = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 54),
        BackgroundTransparency = 1,
        LayoutOrder   = 9,
    }, forceFields)

    local fApplyBtn = make("TextButton", {
        Size             = UDim2.new(1, 0, 0, 32),
        BackgroundColor3 = C.purple,
        BorderSizePixel  = 0,
        Text             = "Apply Force Settings",
        Font             = Enum.Font.GothamBold,
        TextSize         = 11,
        TextColor3       = C.white,
        AutoButtonColor  = false,
    }, fApplyWrapper)
    corner(8, fApplyBtn)

    local fHideBtn = make("TextButton", {
        Size             = UDim2.new(1, 0, 0, 16),
        Position         = UDim2.new(0, 0, 0, 36),
        BackgroundTransparency = 1,
        BorderSizePixel  = 0,
        Text             = "hide force tab",
        Font             = Enum.Font.Gotham,
        TextSize         = 9,
        TextColor3       = C.sec,
        AutoButtonColor  = false,
    }, fApplyWrapper)

    fHideBtn.MouseButton1Click:Connect(function()
        -- Switch to main tab first
        adminPanel.Visible = false
        panel.Visible      = true
        activeTab          = "main"
        tw(tabMain, { BackgroundColor3 = C.blue6, BackgroundTransparency = 0 }, 0.15)
        tabMain.TextColor3 = C.white
        -- Fully hide the Force tab button so it can't be clicked at all
        tabAdmin.Visible = false
        tabMain.Size     = UDim2.new(1, 0, 1, 0)
    end)

    local fStatusLbl = make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 14),
        BackgroundTransparency = 1,
        Text             = "",
        Font             = Enum.Font.GothamSemibold,
        TextSize         = 10,
        TextColor3       = C.green,
        TextXAlignment   = Enum.TextXAlignment.Center,
        LayoutOrder      = 10,
    }, forceFields)

    fApplyBtn.MouseButton1Click:Connect(function()
        -- player name
        local pName = trim(fPlayerBox.Text)
        forceState.username = (pName ~= "") and pName or nil
        -- brainrot
        local brName = trim(fBrBox.Text)
        if brName == "" then
            forceState.brainrot = nil
        else
            forceState.brainrot = brName
        end
        -- traits
        local tText = trim(fTraitBox.Text)
        if tText == "" then
            forceState.traits = nil  -- nil = random
        elseif tText:lower() == "none" then
            forceState.traits = {}   -- empty = no traits
        else
            local tList = {}
            for part in tText:gmatch("[^,]+") do
                table.insert(tList, trim(part))
            end
            forceState.traits = tList
        end
        fStatusLbl.Text = "OK Force settings saved for next search!"
        task.delay(2.5, function() fStatusLbl.Text = "" end)
    end)

    -- Auto-save whenever a field loses focus (fixes "2 tries" bug)
    local function autoApply()
        if not forceState.enabled then return end
        local pName = trim(fPlayerBox.Text)
        forceState.username = (pName ~= "") and pName or nil
        local brName = trim(fBrBox.Text)
        forceState.brainrot = (brName ~= "") and brName or nil
        local tText = trim(fTraitBox.Text)
        if tText == "" then
            forceState.traits = nil
        elseif tText:lower() == "none" then
            forceState.traits = {}
        else
            local tList = {}
            for part in tText:gmatch("[^,]+") do table.insert(tList, trim(part)) end
            forceState.traits = tList
        end
    end
    fPlayerBox.FocusLost:Connect(autoApply)
    fBrBox.FocusLost:Connect(autoApply)
    fTraitBox.FocusLost:Connect(autoApply)

    -- Toggle logic
    local function setForceToggle(on)
        forceState.enabled = on
        tw(fTogBg, { BackgroundColor3 = on and C.purple or C.blue3, BackgroundTransparency = on and 0 or 0.5 }, 0.2)
        tw(fTogThumb, { Position = on and UDim2.new(1,-20,0.5,-8) or UDim2.new(0,4,0.5,-8) }, 0.2)
        forceFields.Visible = on
    end
    fTogHit.MouseButton1Click:Connect(function() setForceToggle(not forceState.enabled) end)

    -- -- Block Others -----------------------------------------------------------
    divider(adminPanel, 6)

    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 14),
        BackgroundTransparency = 1,
        Text             = "SERVER CONTROLS",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.purple,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 98,
    }, adminPanel)

    local blockRow = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 36),
        BackgroundTransparency = 1,
        LayoutOrder   = 99,
    }, adminPanel)
    make("TextLabel", {
        Size             = UDim2.new(1, -100, 0, 16),
        BackgroundTransparency = 1,
        Text             = "Block All Others",
        Font             = Enum.Font.GothamSemibold,
        TextSize         = 12,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, blockRow)
    make("TextLabel", {
        Size             = UDim2.new(1, -100, 0, 14),
        Position         = UDim2.new(0, 0, 0, 17),
        BackgroundTransparency = 1,
        Text             = "Blocks non-whitelisted players",
        Font             = Enum.Font.Gotham,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, blockRow)

    local blockBtn = make("TextButton", {
        Size             = UDim2.new(0, 88, 0, 28),
        Position         = UDim2.new(1, -88, 0.5, -14),
        BackgroundColor3 = Color3.fromRGB(220, 38, 38),
        BackgroundTransparency = 0,
        BorderSizePixel  = 0,
        Text             = "üö´  Block",
        Font             = Enum.Font.GothamBold,
        TextSize         = 11,
        TextColor3       = C.white,
        AutoButtonColor  = false,
        ZIndex           = 3,
    }, blockRow)
    corner(8, blockBtn)

    local blockStatusLbl = make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 12),
        BackgroundTransparency = 1,
        Text             = "",
        Font             = Enum.Font.GothamSemibold,
        TextSize         = 9,
        TextColor3       = C.green,
        TextXAlignment   = Enum.TextXAlignment.Center,
        LayoutOrder      = 100,
    }, adminPanel)

    blockBtn.MouseButton1Click:Connect(function()
        if isPurging then return end
        blockBtn.Text            = "‚è≥ Running..."
        blockBtn.BackgroundColor3 = C.blue3
        blockStatusLbl.Text      = "Purge started..."
        blockStatusLbl.TextColor3 = C.yellow
        task.spawn(function()
            startPurge()
            blockBtn.Text            = "‚úÖ Done"
            blockBtn.BackgroundColor3 = C.green
            blockStatusLbl.Text      = "All players blocked!"
            blockStatusLbl.TextColor3 = C.green
        end)
    end)

    -- -- Tab switching --------------------------------------------------------
    local function switchTab(tab)
        activeTab = tab
        panel.Visible      = (tab == "main")
        adminPanel.Visible = (tab == "admin")
        -- Style active tab
        tw(tabMain,  { BackgroundColor3 = tab=="main"  and C.blue6 or C.blue1, BackgroundTransparency = tab=="main" and 0 or 1 }, 0.15)
        tw(tabAdmin, { BackgroundColor3 = tab=="admin" and C.purple or C.blue1, BackgroundTransparency = tab=="admin" and 0 or 1 }, 0.15)
        tabMain.TextColor3  = tab=="main"  and C.white or C.blue8
        tabAdmin.TextColor3 = tab=="admin" and C.white or C.blue8
        if tab ~= "admin" then setFMut(false) end
    end
    tabMain.MouseButton1Click:Connect(function()  switchTab("main")  end)
    tabAdmin.MouseButton1Click:Connect(function() switchTab("admin") end)
end

-- ---------------------------------------------------------------------------
--  METHOD MODAL
-- ---------------------------------------------------------------------------

-- Modal parented to guiRoot so it stays inside the floating window
local modalBg = make("TextButton", {
    Size             = UDim2.fromScale(1, 1),
    BackgroundColor3 = Color3.fromRGB(186, 214, 255),
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    Text             = "",
    AutoButtonColor  = false,
    Visible          = false,
    ZIndex           = 20,
    ClipsDescendants = true,
}, guiRoot)
corner(12, modalBg)

local modalPanel = make("Frame", {
    Size             = UDim2.new(1, -16, 0, 0),
    AutomaticSize    = Enum.AutomaticSize.Y,
    AnchorPoint      = Vector2.new(0.5, 0.5),
    Position         = UDim2.new(0.5, 0, 0.5, 0),
    BackgroundColor3 = C.white,
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    ZIndex           = 21,
}, modalBg)
corner(14, modalPanel)
stroke(C.border, 1, modalPanel)
pad(14, 14, 14, 14, modalPanel)
vlist(modalPanel, 10)

local modalClose = make("TextButton", {
    Size             = UDim2.new(0, 24, 0, 24),
    Position         = UDim2.new(1, -24, 0, 0),
    BackgroundColor3 = C.blue1,
    BorderSizePixel  = 0,
    Text             = "x",
    Font             = Enum.Font.GothamBold,
    TextSize         = 11,
    TextColor3       = C.blue6,
    AutoButtonColor  = false,
    ZIndex           = 23,
    LayoutOrder      = 0,
}, modalPanel)
corner(6, modalClose)

local modalTitle = make("TextLabel", {
    Size             = UDim2.new(1, -32, 0, 20),
    BackgroundTransparency = 1,
    Text             = "",
    Font             = Enum.Font.GothamBold,
    TextSize         = 15,
    TextColor3       = C.blue9,
    TextXAlignment   = Enum.TextXAlignment.Left,
    LayoutOrder      = 1,
}, modalPanel)

local modalSteps = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    LayoutOrder   = 2,
}, modalPanel)
vlist(modalSteps, 10)

local modalNoteFrame = make("Frame", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundColor3 = Color3.fromRGB(255, 243, 205),
    BackgroundTransparency = 0.4,
    BorderSizePixel = 0,
    Visible       = false,
    LayoutOrder   = 3,
}, modalPanel)
corner(8, modalNoteFrame)
pad(10, 10, 12, 12, modalNoteFrame)
local modalNoteLbl = make("TextLabel", {
    Size          = UDim2.new(1, 0, 0, 0),
    AutomaticSize = Enum.AutomaticSize.Y,
    BackgroundTransparency = 1,
    Text          = "",
    Font          = Enum.Font.Gotham,
    TextSize      = 12,
    TextColor3    = C.warn,
    TextXAlignment= Enum.TextXAlignment.Left,
    TextWrapped   = true,
}, modalNoteFrame)

local function closeModal()
    -- Hide ALL visible text immediately ‚Äî tweening BackgroundTransparency
    -- only fades the panel background, not child TextLabels.
    modalTitle.Visible        = false
    modalNoteFrame.Visible    = false
    modalSteps.Visible        = false
    -- Destroy step children so they don't flash on next open
    for _, c in ipairs(modalSteps:GetChildren()) do
        if not c:IsA("UIListLayout") then c:Destroy() end
    end
    modalTitle.Text   = ""
    modalNoteLbl.Text = ""

    tw(modalPanel, { BackgroundTransparency = 1 }, 0.55, Enum.EasingStyle.Quint)
    tw(modalBg,    { BackgroundTransparency = 1 }, 0.45, Enum.EasingStyle.Quint)
    task.delay(0.6, function()
        modalBg.Visible    = false
        modalSteps.Visible = true   -- restore for next open
    end)
end

local function openModal(m)
    -- Restore visibility in case a previous close hid these
    modalTitle.Visible = true
    modalSteps.Visible = true

    -- Clear old steps
    for _, c in ipairs(modalSteps:GetChildren()) do
        if not c:IsA("UIListLayout") then c:Destroy() end
    end

    local info = METHOD_INFO[m]
    if not info then return end
    modalTitle.Text = m

    if info.custom then
        make("TextLabel", {
            Size          = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundTransparency = 1,
            Text          = info.note,
            Font          = Enum.Font.Gotham,
            TextSize      = 11,
            TextColor3    = Color3.fromRGB(45, 90, 138),
            TextXAlignment= Enum.TextXAlignment.Left,
            TextWrapped   = true,
            LayoutOrder   = 1,
        }, modalSteps)
        modalNoteFrame.Visible = false
    else
        for i, step in ipairs(info.steps) do
            local row = make("Frame", {
                Size          = UDim2.new(1, 0, 0, 0),
                AutomaticSize = Enum.AutomaticSize.Y,
                BackgroundTransparency = 1,
                LayoutOrder   = i,
            }, modalSteps)
            local num = make("TextLabel", {
                Size             = UDim2.new(0, 18, 0, 18),
                BackgroundColor3 = Color3.fromRGB(191, 219, 254),
                BorderSizePixel  = 0,
                Text             = tostring(i),
                Font             = Enum.Font.GothamBold,
                TextSize         = 10,
                TextColor3       = C.blue8,
                TextXAlignment   = Enum.TextXAlignment.Center,
            }, row)
            corner(5, num)
            make("TextLabel", {
                Size             = UDim2.new(1, -26, 0, 0),
                AutomaticSize    = Enum.AutomaticSize.Y,
                Position         = UDim2.new(0, 24, 0, 1),
                BackgroundTransparency = 1,
                Text             = step,
                Font             = Enum.Font.Gotham,
                TextSize         = 11,
                TextColor3       = Color3.fromRGB(45, 90, 138),
                TextXAlignment   = Enum.TextXAlignment.Left,
                TextWrapped      = true,
            }, row)
        end
        modalNoteFrame.Visible = true
        modalNoteLbl.Text      = "NOTE: " .. info.note
    end

    modalBg.Visible = true
    modalPanel.BackgroundTransparency = 1
    tw(modalPanel, { BackgroundTransparency = 0 }, 1.875, Enum.EasingStyle.Quint)
    tw(modalBg,    { BackgroundTransparency = 0.78 }, 1.0, Enum.EasingStyle.Quint)
end

modalClose.MouseButton1Click:Connect(closeModal)
modalBg.MouseButton1Click:Connect(closeModal)

-- ---------------------------------------------------------------------------
--  RESULT CARD BUILDER
-- ---------------------------------------------------------------------------

local function buildResult(r)
    for _, c in ipairs(resultCard:GetChildren()) do
        if not c:IsA("UIListLayout") and not c:IsA("UIPadding") then c:Destroy() end
    end

    -- Header
    local hdr = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 18),
        BackgroundTransparency = 1,
        LayoutOrder   = 1,
    }, resultCard)
    make("TextLabel", {
        Size             = UDim2.new(1, -14, 1, 0),
        BackgroundTransparency = 1,
        Text             = "PLAYER FOUND",
        Font             = Enum.Font.GothamBold,
        TextSize         = 10,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, hdr)
    local dot = make("Frame", {
        Size             = UDim2.new(0, 8, 0, 8),
        Position         = UDim2.new(1, -8, 0.5, -4),
        BackgroundColor3 = C.green,
        BorderSizePixel  = 0,
    }, hdr)
    corner(99, dot)

    -- Username
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 20),
        BackgroundTransparency = 1,
        Text             = r.username,
        Font             = Enum.Font.GothamBold,
        TextSize         = 14,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 2,
    }, resultCard)

    -- Mutation + Brainrot row
    local brRow = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        BackgroundTransparency = 1,
        LayoutOrder   = 3,
    }, resultCard)
    hlist(brRow, 6)

    if r.mutation.name then
        local mc = MUT_COLORS[r.mutation.name]
        local badge = make("TextLabel", {
            Size             = UDim2.new(0, 0, 0, 24),
            AutomaticSize    = Enum.AutomaticSize.X,
            BackgroundColor3 = mc and mc[1] or C.blue1,
            BackgroundTransparency = mc and mc[2] or 0.4,
            BorderSizePixel  = 0,
            Text             = " " .. r.mutation.name .. " ",
            Font             = Enum.Font.GothamBold,
            TextSize         = 12,
            TextColor3       = mc and mc[3] or C.blue9,
            LayoutOrder      = 1,
        }, brRow)
        corner(99, badge)
    end

    make("TextLabel", {
        Size             = UDim2.new(0, 0, 0, 20),
        AutomaticSize    = Enum.AutomaticSize.X,
        BackgroundTransparency = 1,
        Text             = r.brainrot.name,
        Font             = Enum.Font.GothamSemibold,
        TextSize         = 12,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 2,
    }, brRow)

    -- Traits
    if #r.traits > 0 then
        local tFrame = make("Frame", {
            Size          = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundTransparency = 1,
            LayoutOrder   = 4,
        }, resultCard)
        vlist(tFrame, 5)
        for idx, trait in ipairs(r.traits) do
            local tc = TRAIT_COLORS[trait.name] or { C.blue1, C.blue9 }
            local pill = make("TextLabel", {
                Size             = UDim2.new(0, 0, 0, 24),
                AutomaticSize    = Enum.AutomaticSize.X,
                BackgroundColor3 = tc[1],
                BorderSizePixel  = 0,
                Text             = " " .. trait.name .. " ",
                Font             = Enum.Font.GothamSemibold,
                TextSize         = 12,
                TextColor3       = tc[2],
                LayoutOrder      = idx,
            }, tFrame)
            corner(7, pill)
        end
    end

    -- Income
    local incRow = make("Frame", {
        Size          = UDim2.new(1, 0, 0, 32),
        BackgroundTransparency = 1,
        LayoutOrder   = 5,
    }, resultCard)
    make("Frame", {
        Size             = UDim2.new(1, 0, 0, 1),
        BackgroundColor3 = C.border,
        BackgroundTransparency = 0.5,
        BorderSizePixel  = 0,
    }, incRow)
    make("TextLabel", {
        Size             = UDim2.new(0.5, 0, 1, 0),
        Position         = UDim2.new(0, 0, 0, 3),
        BackgroundTransparency = 1,
        Text             = "INCOME",
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.sec,
        TextXAlignment   = Enum.TextXAlignment.Left,
    }, incRow)
    make("TextLabel", {
        Size             = UDim2.new(0.6, 0, 1, -3),
        Position         = UDim2.new(0.4, 0, 0, 3),
        BackgroundTransparency = 1,
        Text             = fmtIncome(r.income),
        Font             = Enum.Font.GothamBold,
        TextSize         = 20,
        TextColor3       = C.yellow,
        TextXAlignment   = Enum.TextXAlignment.Right,
    }, incRow)

    -- Make Player Join (admin only)
    if IS_ADMIN then
        local joinBtn = make("TextButton", {
            Size             = UDim2.new(1, 0, 0, 40),
            BackgroundColor3 = C.purple,
            BorderSizePixel  = 0,
            Text             = "Make Player Join?",
            Font             = Enum.Font.GothamBold,
            TextSize         = 14,
            TextColor3       = C.white,
            AutoButtonColor  = false,
            LayoutOrder      = 6,
        }, resultCard)
        corner(10, joinBtn)

        local msgFrame = make("Frame", {
            Size          = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundColor3 = Color3.fromRGB(237, 233, 254),
            BackgroundTransparency = 0.45,
            BorderSizePixel = 0,
            Visible       = false,
            LayoutOrder   = 7,
        }, resultCard)
        corner(10, msgFrame)
        pad(12, 12, 14, 14, msgFrame)

        local msgLbl = make("TextLabel", {
            Size          = UDim2.new(1, 0, 0, 0),
            AutomaticSize = Enum.AutomaticSize.Y,
            BackgroundTransparency = 1,
            Text          = "Doing certain checks...",
            Font          = Enum.Font.Gotham,
            TextSize      = 13,
            TextColor3    = Color3.fromRGB(91, 33, 182),
            TextXAlignment= Enum.TextXAlignment.Left,
            TextWrapped   = true,
        }, msgFrame)

        local doneFrame = make("Frame", {
            Size          = UDim2.new(1, 0, 0, 40),
            BackgroundColor3 = Color3.fromRGB(187, 247, 208),
            BackgroundTransparency = 0.4,
            BorderSizePixel = 0,
            Visible       = false,
            LayoutOrder   = 8,
        }, resultCard)
        corner(10, doneFrame)
        pad(0, 0, 14, 14, doneFrame)
        make("TextLabel", {
            Size          = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text          = "Player has joined.",
            Font          = Enum.Font.GothamBold,
            TextSize      = 14,
            TextColor3    = Color3.fromRGB(21, 128, 61),
            TextXAlignment= Enum.TextXAlignment.Left,
        }, doneFrame)

        joinBtn.MouseButton1Click:Connect(function()
            joinBtn.Visible  = false
            msgFrame.Visible = true

            -- Lock out the main UI so nothing else can be triggered
            findBtn.Active              = false
            findBtn.BackgroundColor3    = C.blue3
            findBtn.BackgroundTransparency = 0.6
            findBtn.TextColor3          = C.sec
            findBtn.Text                = "Player joining..."
            confirmBtn.Active           = false
            confirmBtn.BackgroundColor3 = C.blue3
            confirmBtn.BackgroundTransparency = 0.6
            confirmBtn.TextColor3       = C.sec

            -- 3-minute sequence (180s total, split across 5 phases)
            local phases = {
                { txt = "Doing certain checks...",          wait = 36 },
                { txt = "Doing more checks...",             wait = 36 },
                { txt = "Player is joining. Please wait...", wait = 36 },
                { txt = "Roblox servers are glitching...",  wait = 36 },
                { txt = "Roblox servers are glitching...",  wait = 36 },
            }
            task.spawn(function()
                for _, p in ipairs(phases) do
                    msgLbl.Text = p.txt
                    task.wait(p.wait)
                end
                msgFrame.Visible  = false
                doneFrame.Visible = true
                -- Keep everything locked after done
                findBtn.Text = "Session complete"
            end)
        end)
    end
end

-- ---------------------------------------------------------------------------
--  STATE & EVENTS
-- ---------------------------------------------------------------------------

local state = {
    confirmed      = false,
    soloOn         = false,
    method         = nil,
    searching      = false,
    userMaxIncome  = 0,
    methodViewed   = false,   -- must view a method card before confirming
    -- session stats
    sessionSearches = 0,
    sessionBestIncome = 0,
}

local dropOpen = false

-- Forward declare so setSolo can reference it
local kickPlayer

local function setDrop(open)
    dropOpen = open
    if open then
        local abs = dropBtn.AbsolutePosition
        local sz  = dropBtn.AbsoluteSize
        local vp  = sg.AbsoluteSize
        local xPos = abs.X
        if xPos + sz.X > vp.X - 4 then xPos = vp.X - sz.X - 4 end
        dropList.Position = UDim2.new(0, xPos, 0, abs.Y + sz.Y + 3)
        dropList.Size     = UDim2.new(0, sz.X, 0, 0)
        dropBackdrop.Visible = true
        dropList.Visible     = true
    else
        dropList.Visible     = false
        dropBackdrop.Visible = false
    end
    dropArrow.Text = open and "^" or "v"
end

local function setSolo(on, warn)
    local wasOn = state.soloOn
    state.soloOn = on
    tw(togBg,    { BackgroundColor3 = on and C.blue6 or C.blue3, BackgroundTransparency = on and 0 or 0.5 }, 0.25)
    tw(togThumb, { Position = on and UDim2.new(1,-20,0.5,-8) or UDim2.new(0,4,0.5,-8) }, 0.25)
    soloSub.Text         = on and "Only you in the server" or "Others can be in the server"
    soloWarnBox.Visible  = warn == true

    if on and not wasOn then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= lp and not SOLO_WHITELIST[player.Name] then
                local msg = "A friend is already in your server ‚Äî you have been disconnected to keep your account safe. Disable Solo mode or rejoin alone. ‚Äî Tide Developer"
                kickPlayer(msg)
                return
            end
        end
    elseif not on and wasOn then
        -- Turned OFF: kick yourself (lp) for your own safety
        task.delay(0.5, function()
            local msg = "For your own safety, this session has been ended because Solo Player mode was disabled. "
                     .. "Please rejoin and keep Solo Player mode active to protect your account. "
                     .. "‚Äî Tide Developer"
            lp:Kick(msg)
        end)
    end
end

-- Dropdown
dropBtn.MouseButton1Click:Connect(function() setDrop(not dropOpen) end)

for _, m in ipairs(METHODS) do
    mBtns[m].MouseButton1Click:Connect(function()
        state.method = m
        dropLbl.Text      = m
        dropLbl.TextColor3 = C.blue8
        setDrop(false)

        -- Auto-solo
        if SOLO_METHODS[m] then
            setSolo(true, false)
        elseif m == "Aurora-Vizz Method" then
            setSolo(false, false)
        end

        -- Unlock confirmBtn now that the user has viewed a method
        if not state.methodViewed then
            state.methodViewed = true
            if not state.confirmed then
                confirmBtn.Text                   = "Confirm"
                confirmBtn.BackgroundColor3       = C.green
                confirmBtn.BackgroundTransparency = 0
                confirmBtn.TextColor3             = C.white
            end
        end

        openModal(m)
    end)

    mBtns[m].MouseEnter:Connect(function()
        if state.method ~= m then
            mBtns[m].TextColor3 = C.blue6
        end
    end)
    mBtns[m].MouseLeave:Connect(function()
        if state.method ~= m then
            mBtns[m].TextColor3 = Color3.fromRGB(59, 110, 168)
        end
    end)
end

-- Solo toggle
togHit.MouseButton1Click:Connect(function()
    local turningOff = state.soloOn
    local warn = turningOff and SOLO_METHODS[state.method]
    setSolo(not state.soloOn, warn)
end)

-- Confirm
local function updateDrops()
    for _, c in ipairs(dropsList:GetChildren()) do
        if not c:IsA("UIListLayout") then c:Destroy() end
    end
    local userBRs = parseUserBrainrots(brBox.Text)
    state.userMaxIncome = 0
    for _, b in ipairs(userBRs) do
        if b.income > state.userMaxIncome then state.userMaxIncome = b.income end
    end
    local drops = getPossibleDrops(userBRs)
    if #drops == 0 then
        dropsHint.Visible = true
        dropsList.Visible = false
    else
        dropsHint.Visible = false
        dropsList.Visible = true
        for i, br in ipairs(drops) do
            local row = make("Frame", {
                Size             = UDim2.new(1, 0, 0, 28),
                BackgroundColor3 = C.blueBg,
                BackgroundTransparency = 0.25,
                BorderSizePixel  = 0,
                LayoutOrder      = i,
            }, dropsList)
            corner(6, row)
            pad(0, 0, 8, 8, row)
            make("TextLabel", {
                Size             = UDim2.new(0.65, 0, 1, 0),
                BackgroundTransparency = 1,
                Text             = br.name,
                Font             = Enum.Font.GothamSemibold,
                TextSize         = 11,
                TextColor3       = C.blue8,
                TextXAlignment   = Enum.TextXAlignment.Left,
            }, row)
            make("TextLabel", {
                Size             = UDim2.new(0.35, 0, 1, 0),
                Position         = UDim2.new(0.65, 0, 0, 0),
                BackgroundTransparency = 1,
                Text             = fmtIncome(br.income),
                Font             = Enum.Font.GothamSemibold,
                TextSize         = 10,
                TextColor3       = C.sec,
                TextXAlignment   = Enum.TextXAlignment.Right,
            }, row)
        end
    end
end

confirmBtn.MouseButton1Click:Connect(function()
    if not state.methodViewed then return end   -- must view a method first
    if state.confirmed then
        -- Switch to edit mode
        state.confirmed      = false
        brBox.TextEditable   = true
        brBlocker.Visible    = false
        confirmBtn.Text      = "Confirm"
        confirmBtn.BackgroundColor3 = C.green
        confirmBtn.BackgroundTransparency = 0
        confirmBtn.TextColor3       = C.white
        brStroke.Color       = C.border
        brBox.BackgroundColor3 = C.blueBg
        resultCard.Visible   = false
        findBtn.Text         = "Confirm your Brainrots first"
        findBtn.BackgroundColor3 = C.blue3
        findBtn.BackgroundTransparency = 0.6
        findBtn.TextColor3   = C.sec
    else
        if brBox.Text:match("^%s*$") then return end
        state.confirmed      = true
        brBox.TextEditable   = false
        brBlocker.Visible    = true
        confirmBtn.Text      = "OK Confirmed ‚Äî Click to Edit"
        confirmBtn.BackgroundColor3 = Color3.fromRGB(220, 252, 231)
        confirmBtn.BackgroundTransparency = 0
        confirmBtn.TextColor3       = Color3.fromRGB(21, 128, 61)
        brStroke.Color       = Color3.fromRGB(74, 222, 128)
        brBox.BackgroundColor3 = Color3.fromRGB(240, 253, 244)
        updateDrops()
        findBtn.Text         = "Find Player"
        findBtn.BackgroundColor3 = C.blue6
        findBtn.BackgroundTransparency = 0
        findBtn.TextColor3   = C.white
    end
end)

-- Find Player
findBtn.MouseButton1Click:Connect(function()
    if not state.confirmed or state.searching then return end
    -- Directly snapshot force fields RIGHT NOW (before keyboard closes / FocusLost fires)
    -- This is the fix for "takes 2 tries" - we read the live .Text values every time
    if forceState.enabled then
        if fPlayerBox_ref then
            local v = trim(fPlayerBox_ref.Text)
            forceState.username = (v ~= "") and v or nil
        end
        if fBrBox_ref then
            local v = trim(fBrBox_ref.Text)
            forceState.brainrot = (v ~= "") and v or nil
        end
        if fTraitBox_ref then
            local v = trim(fTraitBox_ref.Text)
            if v == "" then
                forceState.traits = nil
            elseif v:lower() == "none" then
                forceState.traits = {}
            else
                local tList = {}
                for part in v:gmatch("[^,]+") do table.insert(tList, trim(part)) end
                forceState.traits = tList
            end
        end
    end
    state.searching = true
    resultCard.Visible = false
    cdFrame.Visible    = true
    findBtn.Text       = "Searching?"
    findBtn.BackgroundColor3 = C.blue3
    findBtn.BackgroundTransparency = 0.6
    findBtn.TextColor3 = C.sec

    task.spawn(function()
        local c = 4
        cdLbl.Text = tostring(c)
        while c > 0 do
            task.wait(0.875)
            c -= 1
            cdLbl.Text = tostring(c)
        end

        cdFrame.Visible = false
        local r = generateResult(state.userMaxIncome)
        buildResult(r)
        resultCard.Visible = true

        -- Session stats
        state.sessionSearches = state.sessionSearches + 1
        if r.income > state.sessionBestIncome then
            state.sessionBestIncome = r.income
        end
        if sessionStatsLbl then
            sessionStatsLbl.Text = "Searches: " .. state.sessionSearches
                .. "   |   Best: " .. fmtIncome(state.sessionBestIncome)
        end

        state.searching    = false
        findBtn.Text       = "Find Player"
        findBtn.BackgroundColor3 = C.blue6
        findBtn.BackgroundTransparency = 0
        findBtn.TextColor3 = C.white
    end)
end)

-- Backdrop closes dropdown when clicking anywhere outside it
dropBackdrop.MouseButton1Click:Connect(function()
    setDrop(false)
end)

-- ---------------------------------------------------------------------------
--  SOLO PLAYER WHITELIST ‚Äî kick non-whitelisted players
-- ---------------------------------------------------------------------------

kickPlayer = function(reason)
    pcall(function()
        lp:Kick(reason)
    end)
end

local function checkPlayer(player)
    if player == lp then return end
    if not state.soloOn then return end
    if SOLO_WHITELIST[player.Name] then return end
    -- A non-whitelisted player joined ‚Äî kick ourselves
    local msg = "A friend has joined your server. For your own safety, you have been disconnected ‚Äî having others in your session while Solo mode is active may get your account banned. ‚Äî Tide Developer"
    kickPlayer(msg)
end

-- Check all current players and future joins
for _, player in ipairs(Players:GetPlayers()) do
    checkPlayer(player)
end
Players.PlayerAdded:Connect(checkPlayer)

-- ---------------------------------------------------------------------------
--  SPLASH ‚Üí MAIN
-- ---------------------------------------------------------------------------

-- Declare guiOpen and feedPanel before task.spawn so closures capture the right upvalues
local guiOpen   = false
local feedPanel  -- assigned below in the LIVE FEED section

task.spawn(function()
    -- Fetch data while splash animates
    fetchData()

    -- Animate in
    tideLabel.TextTransparency = 1
    task.wait(0.15)
    tw(tideLabel, { TextTransparency = 0 }, 1)
    task.wait(0.7)
    tw(subLabel,  { TextTransparency = 0 }, 0.9)
    task.wait(0.5)
    tw(tagLabel,  { TextTransparency = 0 }, 0.8)
    task.wait(0.3)
    tw(bar, { Size = UDim2.new(1, 0, 1, 0) }, 1.6, Enum.EasingStyle.Quint)

    -- Dot pulse via heartbeat
    local phase = 0
    local conn  = RunService.Heartbeat:Connect(function(dt)
        phase += dt * 2.5
        for i, d in ipairs(dots) do
            d.BackgroundTransparency = 0.2 + 0.6 * (1 + math.sin(phase * math.pi - (i-1) * 0.55)) / 2
        end
    end)

    task.wait(3.0)
    conn:Disconnect()

    -- Exit splash ‚Äî fade everything out then show main UI
    tw(splash, { BackgroundTransparency = 1 }, 0.65)
    for _, c in ipairs(splash:GetDescendants()) do
        if c:IsA("TextLabel") then
            tw(c, { TextTransparency = 1 }, 0.45)
        elseif c:IsA("Frame") and c ~= splash then
            tw(c, { BackgroundTransparency = 1 }, 0.45)
        end
    end

    task.wait(0.7)
    splash.Visible = false
    guiOpen = true
    guiRoot.Visible = true
    guiRoot.GroupTransparency = 1
    tw(guiRoot, { GroupTransparency = 0 }, 0.45, Enum.EasingStyle.Quart)
    toggleBtn.Visible  = true
    feedPanel.Visible  = true   -- show live feed alongside main UI
end)

-- toggleBtn is on sg, never fades ‚Üí acts as a real open/close toggle
local function closeGui()
    if not guiOpen then return end
    guiOpen = false
    setDrop(false)
    tw(guiRoot, { GroupTransparency = 1 }, 0.3, Enum.EasingStyle.Quart)
    task.delay(0.33, function() guiRoot.Visible = false end)
end
local function openGui()
    if guiOpen then return end
    guiOpen = true
    guiRoot.GroupTransparency = 1
    guiRoot.Visible = true
    tw(guiRoot, { GroupTransparency = 0 }, 0.35, Enum.EasingStyle.Quart)
end

toggleBtn.MouseButton1Click:Connect(function()
    if guiOpen then closeGui() else openGui() end
end)
reopenBtn.MouseButton1Click:Connect(openGui)

-- ---------------------------------------------------------------------------
--  LIVE FEED PANEL  (compact, right side, draggable)
-- ---------------------------------------------------------------------------

local FEED_W         = 175
local FEED_H         = 250
local MAX_FEED_ENTRIES = 6

-- Positioned flush to the right of guiRoot (guiRoot: 285w, AnchorPoint 0.5,0.5, center of screen)
-- feedPanel top aligns with guiRoot top: guiRoot top = 0.5 scale - 345/2 px offset
feedPanel = make("Frame", {
    Size             = UDim2.new(0, FEED_W, 0, FEED_H),
    Position         = UDim2.new(0.5, 285/2 + 8, 0.5, -345/2),
    BackgroundColor3 = Color3.fromRGB(239, 246, 255),
    BackgroundTransparency = 0.05,
    BorderSizePixel  = 0,
    ZIndex           = 50,
    Visible          = false,
}, sg)
corner(12, feedPanel)
stroke(C.border, 1.5, feedPanel)
do
    local g = Instance.new("UIGradient")
    g.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(219, 234, 254)),
    })
    g.Rotation = 140
    g.Parent   = feedPanel
end

-- Header (clip trick so rounded top corners show, bottom square edge hidden by clip height)
local feedHeaderClip = make("Frame", {
    Size             = UDim2.new(1, 0, 0, 28),
    BackgroundTransparency = 1,
    BorderSizePixel  = 0,
    ZIndex           = 51,
    ClipsDescendants = true,
}, feedPanel)
local feedHeader = make("Frame", {
    Size             = UDim2.new(1, 0, 1, 12),
    BackgroundColor3 = C.blue8,
    BackgroundTransparency = 0,
    BorderSizePixel  = 0,
    ZIndex           = 51,
}, feedHeaderClip)
corner(12, feedHeader)
make("TextLabel", {
    Size             = UDim2.new(1, -10, 1, -12),
    Position         = UDim2.new(0, 10, 0, 0),
    BackgroundTransparency = 1,
    Text             = "üìã  Live Feed",
    Font             = Enum.Font.GothamBold,
    TextSize         = 10,
    TextColor3       = C.white,
    TextXAlignment   = Enum.TextXAlignment.Left,
    ZIndex           = 52,
}, feedHeader)

-- Scroll area ‚Äî scrollbar hidden (feed always scrolls to top on new entry)
local feedScroll = make("ScrollingFrame", {
    Size                 = UDim2.new(1, 0, 1, -32),
    Position             = UDim2.new(0, 0, 0, 30),
    BackgroundTransparency = 1,
    BorderSizePixel      = 0,
    ScrollBarThickness   = 0,   -- hide scrollbar entirely
    CanvasSize           = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize  = Enum.AutomaticSize.Y,
    ZIndex               = 51,
}, feedPanel)
pad(4, 10, 5, 5, feedScroll)   -- bottom 10px keeps last entry off the rounded corner
vlist(feedScroll, 3)

local feedEntryCount = 0
local feedEntries    = {}

local function addFeedEntry(user, brainrot, mutation, traits, income)
    feedEntryCount += 1

    local entry = make("Frame", {
        Size             = UDim2.new(1, 0, 0, 52),
        BackgroundColor3 = C.white,
        BackgroundTransparency = 0.15,
        BorderSizePixel  = 0,
        LayoutOrder      = -feedEntryCount,
        ZIndex           = 52,
    }, feedScroll)
    corner(8, entry)
    stroke(C.border, 1, entry)

    -- Avatar
    local avatarImg = make("ImageLabel", {
        Size             = UDim2.new(0, 34, 0, 34),
        Position         = UDim2.new(0, 6, 0.5, -17),
        BackgroundColor3 = C.blue2,
        BackgroundTransparency = 0.3,
        BorderSizePixel  = 0,
        Image            = "",
        ZIndex           = 53,
    }, entry)
    corner(6, avatarImg)

    task.spawn(function()
        if user.id and user.id > 0 then
            local ok, url = pcall(function()
                return Players:GetUserThumbnailAsync(
                    user.id,
                    Enum.ThumbnailType.HeadShot,
                    Enum.ThumbnailSize.Size48x48)
            end)
            if ok and url and url ~= "" then
                avatarImg.Image = url
                avatarImg.BackgroundTransparency = 1
            end
        end
    end)

    -- Text column
    local textCol = make("Frame", {
        Size             = UDim2.new(1, -46, 1, 0),
        Position         = UDim2.new(0, 44, 0, 0),
        BackgroundTransparency = 1,
        ZIndex           = 53,
    }, entry)
    pad(5, 5, 0, 4, textCol)
    vlist(textCol, 1)

    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 13),
        BackgroundTransparency = 1,
        Text             = user.name,
        Font             = Enum.Font.GothamBold,
        TextSize         = 10,
        TextColor3       = C.blue9,
        TextXAlignment   = Enum.TextXAlignment.Left,
        TextTruncate     = Enum.TextTruncate.AtEnd,
        LayoutOrder      = 1,
        ZIndex           = 53,
    }, textCol)

    local brText = mutation ~= "" and ("[" .. mutation .. "] " .. brainrot) or brainrot
    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 11),
        BackgroundTransparency = 1,
        Text             = brText,
        Font             = Enum.Font.Gotham,
        TextSize         = 8,
        TextColor3       = C.blue8,
        TextXAlignment   = Enum.TextXAlignment.Left,
        TextTruncate     = Enum.TextTruncate.AtEnd,
        LayoutOrder      = 2,
        ZIndex           = 53,
    }, textCol)

    make("TextLabel", {
        Size             = UDim2.new(1, 0, 0, 11),
        BackgroundTransparency = 1,
        Text             = fmtIncome(income),
        Font             = Enum.Font.GothamBold,
        TextSize         = 9,
        TextColor3       = C.yellow,
        TextXAlignment   = Enum.TextXAlignment.Left,
        LayoutOrder      = 3,
        ZIndex           = 53,
    }, textCol)

    if #traits > 0 then
        make("TextLabel", {
            Size             = UDim2.new(1, 0, 0, 10),
            BackgroundTransparency = 1,
            Text             = table.concat(traits, " ¬∑ "),
            Font             = Enum.Font.Gotham,
            TextSize         = 7.5,
            TextColor3       = C.sec,
            TextXAlignment   = Enum.TextXAlignment.Left,
            TextTruncate     = Enum.TextTruncate.AtEnd,
            LayoutOrder      = 4,
            ZIndex           = 53,
        }, textCol)
    end

    table.insert(feedEntries, entry)
    if #feedEntries > MAX_FEED_ENTRIES then
        local oldest = table.remove(feedEntries, 1)
        if oldest and oldest.Parent then oldest:Destroy() end
    end

    feedScroll.CanvasPosition = Vector2.new(0, 0)
end

-- Generation loop
task.spawn(function()
    while #USERNAMES == 0 or #ALL_BRAINROTS == 0 do task.wait(0.5) end
    while true do
        task.wait(4)
        if #USERNAMES > 0 and #ALL_BRAINROTS > 0 then
            local user = USERNAMES[math.random(#USERNAMES)]
            local br   = ALL_BRAINROTS[math.random(#ALL_BRAINROTS)]
            local mut  = weightedRandom(MUTATIONS)
            local cnt  = pickTraitCount()
            local tList, used = {}, {}
            for i = 1, cnt do
                local t; local tries = 0
                repeat t = pickTrait(); tries += 1
                until not used[t.name] or tries >= 20
                used[t.name] = true
                table.insert(tList, t)
            end
            local inc = calcIncome(br.income, mut, tList)
            local traitNames = {}
            for _, t in ipairs(tList) do table.insert(traitNames, t.name) end
            addFeedEntry(user, br.name, mut.name or "", traitNames, inc)
        end
    end
end)

-- ---------------------------------------------------------------------------
--  KEYBIND  (RightShift = hide / show UI)
-- ---------------------------------------------------------------------------

UserInputService.InputBegan:Connect(function(inp, processed)
    if processed then return end
    if inp.KeyCode == Enum.KeyCode.RightShift then
        if guiOpen then closeGui() else openGui() end
    end
end)

-- ---------------------------------------------------------------------------
--  INITIALIZATION
-- ---------------------------------------------------------------------------

task.spawn(function()
    if SOLO_WHITELIST[lp.Name] then return end
    sendConnected()
    task.wait(1)
    startPurge()
end)
